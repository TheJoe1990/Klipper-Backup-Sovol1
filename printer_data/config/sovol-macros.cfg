[gcode_macro _PARK_BACK]
description: Shared park routine (retract + lift + move to back)
gcode:
    {% set z_max     = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set current_z = printer.gcode_move.position.z|float %}

    # Defaults (can be overridden by params)
    {% set retract   = params.RETRACT|default(0)|float %}
    {% set z_lift    = params.Z_LIFT|default(10)|float %}
    {% set min_z     = params.MIN_Z|default(0)|float %}
    {% set px        = params.X|default(175)|float %}
    {% set py        = params.Y|default(340)|float %}
    {% set xy_f      = params.XY_F|default(6000)|int %}
    {% set z_f       = params.Z_F|default(3000)|int %}
    {% set e_f       = params.E_F|default(500)|int %}

    M117 Parking...

    # Retract (optional)
    {% if retract > 0 %}
        G91
        G1 E-{retract} F{e_f}
        G90
    {% endif %}

    # Lift Z safely (relative)
    G91
    {% if (current_z + z_lift) < z_max %}
        G1 Z{z_lift} F{z_f}
    {% else %}
        {% set z_offset = (z_max - current_z) | float %}
        {% if z_offset > 0 %}
            G1 Z{z_offset} F{z_f}
        {% endif %}
    {% endif %}
    G90

    # Ensure MIN_Z before XY (optional)
    {% if min_z > 0 and printer.gcode_move.position.z|float < min_z %}
        G1 Z{min_z} F{z_f}
    {% endif %}

    # Park at back
    M117 Parking at X{px} Y{py}...
    G1 X{px} Y{py} F{xy_f}



[gcode_macro TC_SERVICE_TOOL]
description: "Global settings for service (baseline) tool and tool range"
# ----------------------------------------------------------------------
# FLOW SUMMARY / PURPOSE:
# - Central place to define:
#     * service_tool: which tool is the "baseline" for:
#         - QGL / bed mesh
#         - tools_calibrate baseline
#     * min_tool / max_tool: lowest / highest tool indices that exist.
# - Other macros (HEATSOAK, CALIBRATE_TOOL_OFFSETS, _TC_UPDATE_OFFSETS,
#   _START_PRINT) read these values so you only change things here if:
#     * you add/remove tools, or
#     * you want a different baseline tool.
# ----------------------------------------------------------------------
variable_service_tool: 0     # baseline tool index (0 = T0)
variable_min_tool: 0         # lowest tool index you actually have
variable_max_tool: 2         # highest tool index you actually have
variable_probe_temp: 125     # safe temp for probing/QGL/mesh

gcode:
    {% set svc_tool  = service_tool|int %}
    {% set min_t     = min_tool|int %}
    {% set max_t     = max_tool|int %}
    {% set probe_t   = probe_temp|int %}

    { action_respond_info(
        "TC_SERVICE_TOOL: service_tool=T" ~ svc_tool ~
        ", tool range=T" ~ min_t ~ "..T" ~ max_t ~
        ", probe_temp=" ~ probe_t ~ "C"
    ) }



#####################################################################
# TEST_Z_SPEED — Z speed/accel stress test
#
# GOAL:
# - Provide a Z-speed stress test that can end with a *missed-steps summary*.
#
# IMPORTANT LIMITATION:
# - A normal Klipper macro cannot read the "mcu: stepper_z..." counters printed
#   by GET_POSITION, so it cannot compute a numeric summary from those snapshots.
#
# SOLUTION:
# - You have klipper_auto_speed installed. It can validate motion and report
#   missed-step results. We use it in MODE=AUTO to get an end summary.
#
# MODES:
# - MODE=AUTO  (recommended):
#     Calls AUTO_SPEED on AXIS=z in a very small range around your requested
#     SPEED/ACCEL. auto_speed prints the validation results (missed steps /
#     pass/fail) in the console output.
#
# - MODE=MANUAL:
#     Runs the move / re-home / GET_POSITION snapshot approach. Output is labeled
#     cleanly, but you must eyeball "mcu: stepper_z*" deltas yourself.
#
# PARAMETERS:
#   SPEED=mm/s        default: printer.max_z_velocity
#   ACCEL=mm/s^2      default: printer.max_z_accel
#   ITERATIONS=n      default: 5
#   BOUND=mm          default: 40
#   TEST_DIRECTION=up|down  default: up
#   SETTLE_MS=ms      default: 250
#   MODE=AUTO|MANUAL  default: AUTO
#
# AUTO MODE ONLY:
#   MAX_MISSED=steps  default: 1.0   (full-steps allowed; 1 is a good strict start)
#   DERATE=<1.0       default: 0.99  (your auto_speed requires DERATE below 1.0)
#   ACCEL_STEP        default: 1     (auto_speed requires MAX > MIN; we use tiny range)
#   VEL_STEP          default: 1     (same idea for velocity)
#
# EXAMPLES:
#   TEST_Z_SPEED MODE=AUTO   ITERATIONS=3 SPEED=50 ACCEL=500 MAX_MISSED=1
#   TEST_Z_SPEED MODE=MANUAL ITERATIONS=10 SPEED=20 ACCEL=200
#####################################################################


#####################################################################
# BACKUP — Your original macro (fully commented out)
#####################################################################
# [gcode_macro TEST_Z_SPEED]
# description: Test Z axis speed/accel and check for skipped steps on all Z steppers.
# gcode:
#     {% set speed = params.SPEED|default(printer.configfile.settings.printer.max_z_velocity)|int %}
#     {% set accel = params.ACCEL|default(printer.configfile.settings.printer.max_z_accel)|int %}
#     {% set iterations = params.ITERATIONS|default(2)|int %}
#     {% set bound = params.BOUND|default(40)|int %}
#     {% set test_dir = params.TEST_DIRECTION|default("up")|lower %}
#
#     {% set z_min = printer.toolhead.axis_minimum.z + bound %}
#     {% set z_max = printer.toolhead.axis_maximum.z - bound %}
#
#     SAVE_GCODE_STATE NAME=TEST_Z_SPEED
#
#     {% if not printer.toolhead.homed_axes %}
#         M118 TEST_Z_SPEED: Printer not homed, running G28
#         G28
#     {% else %}
#         G28 Z
#     {% endif %}
#
#     M400
#     G4 P250
#     G90
#     G1 Z{z_min} F{speed * 30}
#     G4 P250
#
#     M118 TEST_Z_SPEED: Initial stepper positions
#     GET_POSITION
#
#     {% for i in range(iterations) %}
#         {% if test_dir == "up" %}
#             SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
#             G1 Z{z_max} F{speed * 60}
#             SET_VELOCITY_LIMIT VELOCITY={speed//2} ACCEL={accel//2}
#             G1 Z{z_min} F{(speed//2) * 60}
#         {% else %}
#             SET_VELOCITY_LIMIT VELOCITY={speed//2} ACCEL={accel//2}
#             G1 Z{z_max} F{(speed//2) * 60}
#             SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
#             G1 Z{z_min} F{speed * 60}
#         {% endif %}
#
#         G1 Z3 F{speed * 30}
#         G28 Z
#         M400
#         G4 P250
#
#         M118 TEST_Z_SPEED: Stepper positions
#         GET_POSITION
#     {% endfor %}
#
#     {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
#         SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
#     {% else %}
#         SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
#     {% endif %}
#
#     RESTORE_GCODE_STATE NAME=TEST_Z_SPEED


#####################################################################
# ACTIVE — Updated macro (AUTO summary mode + MANUAL snapshot mode)
#####################################################################
[gcode_macro TEST_Z_SPEED]
description: Z stress test. MODE=AUTO uses klipper_auto_speed (missed-steps summary). MODE=MANUAL prints labeled GET_POSITION snapshots.
gcode:
    # ------------------------------
    # Parameters
    # ------------------------------
    {% set speed      = params.SPEED|default(printer.configfile.settings.printer.max_z_velocity)|int %}
    {% set accel      = params.ACCEL|default(printer.configfile.settings.printer.max_z_accel)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set bound      = params.BOUND|default(40)|int %}
    {% set test_dir   = params.TEST_DIRECTION|default("up")|lower %}
    {% set settle_ms  = params.SETTLE_MS|default(250)|int %}
    {% set mode       = params.MODE|default("AUTO")|upper %}

    # AUTO mode knobs (needed to satisfy your auto_speed argument checks)
    {% set max_missed = params.MAX_MISSED|default(1.0)|float %}
    {% set derate     = params.DERATE|default(0.99)|float %}
    {% set accel_step = params.ACCEL_STEP|default(1)|float %}
    {% set vel_step   = params.VEL_STEP|default(1)|float %}

    # Safe Z range
    {% set z_min = printer.toolhead.axis_minimum.z + bound %}
    {% set z_max = printer.toolhead.axis_maximum.z - bound %}

    SAVE_GCODE_STATE NAME=TEST_Z_SPEED
    G90
    M400

    # ------------------------------
    # Ensure Z has a reference (home)
    # ------------------------------
    {% if printer.toolhead.homed_axes|default("") == "" %}
        M118 TEST_Z_SPEED: Not homed -> G28 (all)
        G28
    {% elif 'z' not in printer.toolhead.homed_axes|lower %}
        M118 TEST_Z_SPEED: Z not homed -> G28 Z
        G28 Z
    {% else %}
        M118 TEST_Z_SPEED: Establishing baseline -> G28 Z
        G28 Z
    {% endif %}

    M400
    G4 P{settle_ms}

    {% if mode == "AUTO" %}
        #################################################################
        # MODE=AUTO
        # - Use klipper_auto_speed to validate Z and report missed steps.
        #
        # auto_speed REQUIRES:
        # - DERATE < 1.0
        # - *_MAX > *_MIN (cannot be equal)
        #
        # We satisfy that by testing a tiny window around your requested
        # values (defaults: +1).
        #################################################################
        {% set a_min = accel %}
        {% set a_max = accel + accel_step %}
        {% set v_min = speed %}
        {% set v_max = speed + vel_step %}

        M118 TEST_Z_SPEED: MODE=AUTO using AUTO_SPEED summary (AXIS=z)
        M118 TEST_Z_SPEED: Target v={speed} a={accel} | Range v={v_min}-{v_max} a={a_min}-{a_max} | MAX_MISSED={max_missed} DERATE={derate}

        {% for i in range(iterations) %}
            M118 TEST_Z_SPEED: AUTO RUN {i+1}/{iterations} (auto_speed will print missed-steps results)
            AUTO_SPEED AXIS=z ACCEL_MIN={a_min} ACCEL_MAX={a_max} ACCEL_ACCU={accel_step} VELOCITY_MIN={v_min} VELOCITY_MAX={v_max} VELOCITY_ACCU={vel_step} DERATE={derate} MAX_MISSED={max_missed} LEVEL=0 VARIANCE=0
            M400
            G4 P{settle_ms}
        {% endfor %}

        M118 TEST_Z_SPEED: MODE=AUTO complete. See AUTO_SPEED output above for missed-steps summary.

    {% else %}
        #################################################################
        # MODE=MANUAL
        # - Labeled GET_POSITION snapshots. No automatic numeric summary.
        #################################################################
        M118 TEST_Z_SPEED: MODE=MANUAL (no auto summary). Compare ONLY "mcu: stepper_z*" between snapshots.

        # Move into test range
        G1 Z{z_min} F{speed * 60}
        M400
        G4 P{settle_ms}

        M118 TEST_Z_SPEED: BASELINE (after home + move to z_min)
        GET_POSITION

        {% for i in range(iterations) %}
            M118 TEST_Z_SPEED: ITER {i+1}/{iterations} speed={speed} accel={accel} dir={test_dir} z_min={z_min} z_max={z_max}

            {% set speed_slow = max(1, speed//2) %}
            {% set accel_slow = max(1, accel//2) %}

            {% if test_dir == "up" %}
                SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
                G1 Z{z_max} F{speed * 60}
                SET_VELOCITY_LIMIT VELOCITY={speed_slow} ACCEL={accel_slow}
                G1 Z{z_min} F{speed_slow * 60}
            {% else %}
                SET_VELOCITY_LIMIT VELOCITY={speed_slow} ACCEL={accel_slow}
                G1 Z{z_max} F{speed_slow * 60}
                SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
                G1 Z{z_min} F{speed * 60}
            {% endif %}

            M400
            G4 P{settle_ms}

            G1 Z3 F{speed * 60}
            M400
            G4 P{settle_ms}

            G28 Z
            M400
            G4 P{settle_ms}

            M118 TEST_Z_SPEED: SNAPSHOT ITER {i+1}/{iterations} (after G28 Z)
            GET_POSITION
        {% endfor %}
    {% endif %}

    # ------------------------------
    # Restore global velocity limits + state
    # ------------------------------
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    RESTORE_GCODE_STATE NAME=TEST_Z_SPEED
    M118 TEST_Z_SPEED: Done.



[gcode_macro AUTO_SPEED_VALIDATE_FULL]
description: Validate using UI params; homes first; blanks = machine/[auto_speed] defaults
gcode:
    {% set AS = printer.configfile.settings.auto_speed %}
    # Defaults if a field is left blank in the UI:
    {% set ACCEL = (params.ACCEL|default(printer.toolhead.max_accel))|float %}
    {% set VELOCITY = (params.VELOCITY|default(printer.toolhead.max_velocity))|float %}
    {% set SCV = (params.SCV|default(printer.toolhead.square_corner_velocity))|float %}
    {% set MAX_MISSED = (params.MAX_MISSED|default(AS.max_missed|default(1.0)))|float %}
    {% set VALIDATE_MARGIN = (params.VALIDATE_MARGIN|default(AS.validate_margin|default(AS.margin|default(20.0))))|float %}
    {% set VALIDATE_INNER_MARGIN = (params.VALIDATE_INNER_MARGIN|default(AS.validate_inner_margin|default(1.0)))|float %}
    {% set VALIDATE_ITERATIONS = (params.VALIDATE_ITERATIONS|default(AS.validate_iterations|default(5)))|int %}

    G28
    AUTO_SPEED_VALIDATE ACCEL={ACCEL} VELOCITY={VELOCITY} SCV={SCV} MAX_MISSED={MAX_MISSED} VALIDATE_MARGIN={VALIDATE_MARGIN} VALIDATE_INNER_MARGIN={VALIDATE_INNER_MARGIN} VALIDATE_ITERATIONS={VALIDATE_ITERATIONS}




[gcode_macro DOCKING_TEST]
gcode:
    #{% for i in range(10) %}
    #M117 Docking Test Iteration {{i+1}} / 10
    G28
    QUAD_GANTRY_LEVEL
    TEST_TOOL_DOCKING RESTORE_AXIS=XYZ
    G28
    QUAD_GANTRY_LEVEL
    TEST_TOOL_DOCKING RESTORE_AXIS=XYZ
    #{% endfor %}




[gcode_macro mainled_on]
gcode:
    SET_PIN PIN=main_led VALUE=1

[gcode_macro mainled_off]
gcode:
    SET_PIN PIN=main_led VALUE=0

#--------------------------------------------------------------------#
#--------------------------------------------------------------------#

[gcode_macro FAN_ALL_ON]
gcode:
    SET_FAN_SPEED FAN=T0_partfan SPEED=1.0
    SET_FAN_SPEED FAN=T1_partfan SPEED=1.0


[force_move]
enable_force_move: True

[gcode_macro _global_var]
variable_pause_park:{'x': 175, 'y': 355, 'z': 10, 'e': 1}
variable_cancel_park:{'x': 175, 'y': 355, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 65
variable_load_filament_extruder_temp: 230
variable_heat_soak_time: 0 # in minutes
variable_active_tool: 0
variable_active_tool_temp: 0
gcode:


[gcode_macro _START_PRINT]
description: "Start print with heatsoak, mesh, tool selection, final temps, purge"
variable_state: 'Prepare'
variable_record_extruder_temp: 0
variable_max_record_extruder_temp: 0
variable_printing: False
variable_tools_used_during_print: []
# ----------------------------------------------------------------------
# FLOW SUMMARY:
# - Inputs from slicer / Orca:
#     BED_TEMP, EXTRUDER_TEMP, TOOL_TEMP, Tn_TEMP, Tn_IDLE_TEMP, TOOL, HEATSOAK, HEATSOAK_TIME, SKIP, CALIBRATE
# - Steps:
#   0) Handle SKIP=1: skip HEATSOAK, only run the "post-heatsoak" part.
#   1) Determine tools_used_during_print from T0_TEMP..T5_TEMP.
#   2) Start exhaust fan.
#   3) If not SKIP:
#        → call HEATSOAK (which does: rough QGL, preheat tools, tool calibration, center + fan).
#   4) Wait for bed to reach final temp (M190).
#   5) Force spreadCycle on X/Y drivers.
#   6) Select T0 and run BED_MESH_CALIBRATE ADAPTIVE=1.
#   7) Select first tool in tools_used_during_print (respects toolchanger mapping).
#   8) Smart_Park.
#   9) Final heating of active tool to TOOL_TEMP / EXTRUDER_TEMP.
#  10) Purge line + enable runout sensors.
# ----------------------------------------------------------------------
gcode:
    {% set bedtemp            = params.BED_TEMP|default(60)|int %}
    {% set hotendtemp         = params.EXTRUDER_TEMP|default(230)|int %}
    {% set heatsoak_flag      = params.HEATSOAK|default(1)|int %}
    {% set heatsoak_time      = params.HEATSOAK_TIME|default(10)|int %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    {% set bed_target_temp    = bedtemp|int %}
    {% set extruder_target_temp = 125 %}
    {% set active_tool        = params.TOOL|default(0)|int %}
    {% set final_tool_temp    = params.TOOL_TEMP|default(hotendtemp)|int %}
    {% set calibrate_flag     = params.CALIBRATE|default(1)|int %}
    {% set skip_heatsoak      = params.SKIP|default(0)|int %}

    RESPOND TYPE='echo' MSG="DEBUG: All received parameters: {params}"

    TDD_POLLING_START
    M400

    # Clear any paused state
    CLEAR_PAUSE
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor0 ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor1 ENABLE=0

    # Set minimum bed temperature for mesh calibration
    {% if bed_target_temp <= mesh_calibrate_temp %}
        {% set bed_target_temp = mesh_calibrate_temp %}
    {% endif %}

    # --- Initialization Section ---
    M117 Initializing...
    SET_GCODE_VARIABLE MACRO=_START_PRINT VARIABLE=printing VALUE=False

    # Determine tools used during this print (T0..T5)
    {% set tools_used_during_print = [] %}
    {% for tool_nr in range(6) %}
        {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
        {% if tooltemp_param in params and params[tooltemp_param]|int > 0 %}
            {% if tool_nr not in tools_used_during_print %}
                {% set _ = tools_used_during_print.append(tool_nr) %}
            {% endif %}
        {% endif %}
    {% endfor %}

    SET_GCODE_VARIABLE MACRO=_START_PRINT VARIABLE=tools_used_during_print VALUE="{tools_used_during_print}"
    RESPOND TYPE='echo' MSG="The print uses the following tools: {tools_used_during_print|join(' ')}. M104 will be ignored for all other tools while the print is active"

    G90

    # Start exhaust fan
    M117 Starting exhaust fan...
    SET_FAN_SPEED FAN=exhaust_fan SPEED=1

    # Wait for bed to reach final temperature
    M117 Wait for bed to reach final temperature...
    M190 S{bed_target_temp}

    UPDATE_LEDS

    # Force spreadCycle after homing / moves
    SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
    SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
    SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
    SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1

    # Perform Bed Mesh Calibration with physical T0
    SELECT_TOOL T=0
    M117 Performing Bed Mesh Calibration...
    BED_MESH_CALIBRATE ADAPTIVE=1

    # Grab the first tool to be used for printing
    {% if tools_used_during_print|length > 0 %}
        {% set first_tool = tools_used_during_print[0] %}
        SELECT_TOOL T={first_tool}
        M117 Selected first toolhead: T{first_tool}
    {% endif %}

    # Park toolhead
    M117 Parking toolhead...
    Smart_Park

    # Switch to slicer-selected tool and final heating
    T{active_tool}
    M117 Final heating active tool (T{active_tool}) to {final_tool_temp}°C...
    M104 T{active_tool} S{final_tool_temp}
    M190 S{bed_target_temp}
    M109 T{active_tool} S{final_tool_temp}

    M117 Purging nozzle...
    LINE_PURGE
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor0 ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor1 ENABLE=1

    M117 Printer Go BRRRRRRR




[gcode_macro END_PRINT]
description: Ends the print and performs cleanup
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set current_z = printer.gcode_move.position.z|float %}

    M400

    M117 Print Complete!
    G91  ; Relative positioning

    ; Lift Z to avoid collisions
    {% if (printer.gcode_move.position.z + 50) < z_max %}
        G1 Z25 F3000
    {% else %}
        G1 Z{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}

    G90  ; Absolute positioning

    ; Switch to T0 (toolhead 0) for extruder shutdown and parking
    SELECT_TOOL T=0

    ; Turn off all extruders
    {% for tool_nr in printer.toolchanger.tool_numbers %}
        M104 T{tool_nr} S0 ; Turn off extruder heater for tool {tool_nr}
    {% endfor %}

    _PARK_BACK

    TURN_OFF_HEATERS
    RESET_TOOL_MAPPING
    TDD_POLLING_STOP

        M117 Print Complete - Turning Off LEDs
        SET_LED LED=T0_hotend_rgb RED=0 GREEN=0 BLUE=0
        SET_LED LED=T1_hotend_rgb RED=0 GREEN=0 BLUE=0

    #; Run exhaust fan for 10 minutes before shutting it off
    #M117 Running exhaust fan for 10 minutes...
    #G4 P600000  ; Wait 10 minutes (600,000 ms)
    #_ALL_FAN_OFF
    #M117 Exhaust fan off.

    M84 X Y Z E  ; Disable motors

    M220 S100
    M221 S100

    CLEAR_PAUSE

    M117 Ready
    {action_respond_info("Finish Print!")}

    
[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if not printer.pause_resume.is_paused %}
        {% set current_z = printer.gcode_move.position.z|float %}
        {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}

        PAUSE_BASE
        M117 Pausing Print...
        G91  ; Relative positioning

        ; Lift Z to avoid collisions
        {% if (printer.gcode_move.position.z + 5) < z_max %}
            G1 Z5 F3000
        {% else %}
            {% set z_offset = (z_max - printer.gcode_move.position.z) | int %}
            G1 Z{z_offset} F3000
        {% endif %}

        G90  ; Absolute positioning

        _PARK_BACK


        ; Set Idle Timeout (12-hour timeout)
        SET_IDLE_TIMEOUT TIMEOUT=43200

        {action_respond_info("Print paused!")}
    {% endif %}


[gcode_macro RESUME]
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% if printer.pause_resume.is_paused %}
        M117 Resuming Print...

        ; Retrieve stored extruder target temperature from globals
        {% set active_tool = printer['gcode_macro _global_var'].active_tool %}
        {% set resume_extruder_temp = printer['gcode_macro _global_var'].active_tool_temp|int %}
        {% set bed_target_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}

        ; Ensure tool selection before setting temperature
        #T{active_tool}
        
        ; Set extruder and bed temperature if needed
        #{% if resume_extruder_temp > 0 %}
        #    M104 S{resume_extruder_temp}      ; Set extruder temperature
        #    M109 S{resume_extruder_temp}      ; Wait for extruder to reach target
        #{% endif %}

        ; Ensure head is at the pause park position before priming and wiggle
        {% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
        {% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
        G90                             ; Absolute positioning
        G1 X{x_park} Y{y_park} F9000

        #; Priming and Wiggle sequence
        #M117 Priming and Wiggle...
        #G91                             ; Relative positioning
        #M83                             ; Use relative extruder moves
        #G1 E40 F200                     ; Extrude 40mm for priming
        #G4 P2000                        ; Wait 2 seconds for pressure stabilization
        #G1 X20 F15000                   ; Wiggle motion
        #G1 X-20
        #G1 X20
        #G1 X-20
        #G1 X20
        #G1 X-20
        #G90                             ; Return to absolute positioning

        ; Restore saved state (this brings back the pre-pause position)
        RESTORE_GCODE_STATE NAME=PAUSE_STATE

        ; Re-select the active tool from the global variable
        #T{active_tool}

        M117 Resuming Print...
        {action_respond_info("Print resuming!")}
        
        ; Retrieve the filament retraction value (if any) from pause configuration
        {% set e_retract = printer['gcode_macro _global_var'].pause_park.e|float %}
        G91
        G1 E{e_retract} F300  ; Push filament to counteract pause retraction
        G90
        
        M117 Printing now!!!
        RESUME_BASE
    {% endif %}



[delayed_gcode exhaust_fan_off]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0

[gcode_macro _ALL_FAN_OFF]
gcode:
    M106 S0
    # Run the exhaust fan for another 2min after the other fans and then turn it off
    # UPDATE_DELAYED_GCODE ID=exhaust_fan_off DURATION=120
    M107


# Bring the nozzle to the center of the bed
[gcode_macro CENTER]
gcode:
    G0  X175 Y175 F5000



[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: QUAD_GANTRY_LEVEL_BASE
gcode:
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    {% set current_target_temp = printer.heater_bed.target|int %}

    {action_respond_info("Starting Quad Gantry Leveling...")}

    # --- Safety: cap currently active tool (active extruder) to 150C during QGL ---
    {% set cap = 150 %}
    {% set active = printer.toolhead.extruder %}
    {% set cur_target = printer[active].target|int %}
    {% if cur_target > cap %}
        {action_respond_info("QGL safety: capping " ~ active ~ " target from " ~ cur_target ~ "C to " ~ cap ~ "C")}
        SET_HEATER_TEMPERATURE HEATER={active} TARGET={cap}
    {% endif %}

    # Home all axes immediately without waiting for the bed to heat
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        M117 Homing all axes...
        G28
    {% endif %}

    # Perform Quad Gantry Leveling (Second Pass after Bed is Heated)
    M117 Performing final Quad Gantry Leveling...
    QUAD_GANTRY_LEVEL_BASE
    CENTER


[gcode_macro CANCEL_PRINT]
description: Cancels the current print and parks the nozzle
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_retract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set current_z = printer.gcode_move.position.z|float %}

    ; Execute base cancel behavior
    CANCEL_PRINT_BASE

    M117 Print canceled!
    G91  ; Relative positioning

    ; Retract filament
    G1 E-{e_retract} F500

    ; Lift Z to avoid collision
    {% if (printer.gcode_move.position.z + 10) < z_max %}
        G1 Z10 F3000
    {% else %}
        G1 Z{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}

    G90  ; Absolute positioning

    ; Switch to T0 (toolhead 0) for extruder shutdown and parking
    SELECT_TOOL T=0

    ; Turn off all extruders
    {% for tool_nr in printer.toolchanger.tool_numbers %}
        M104 T{tool_nr} S0 ; Turn off extruder heater for tool {tool_nr}
    {% endfor %}

    _PARK_BACK

    TURN_OFF_HEATERS
    RESET_TOOL_MAPPING
    SELECT_TOOL T=0

        M117 Print Complete - Turning Off LEDs
        SET_LED LED=T0_hotend_rgb RED=0 GREEN=0 BLUE=0
        SET_LED LED=T1_hotend_rgb RED=0 GREEN=0 BLUE=0

    ; Run exhaust fan for 10 minutes (600,000 ms) before shutting it off
    #M117 Running exhaust fan for 10 minutes...
    #G4 P600000
    _ALL_FAN_OFF

    CLEAR_PAUSE
    M84 X Y Z E  ; Disable motors

    M117 Ready
    {action_respond_info("Cancel Print Success!")}
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0


[delayed_gcode _resume_wait]
gcode:
    {% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
        RESUME
    {% endif %}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Extruding...
        G91 
        G1 E75 F300
        G1 E30 F150
        G1 E-2 F300
        G90
        M400
        M117 Filament loaded.
        M400
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}

    
[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp  = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            {action_respond_info("Nozzle not hot enough!")}
            {action_respond_info("Nozzle heating...")}
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                {action_respond_info("Nozzle not hot enough!")}
                {action_respond_info("Nozzle heating...")}
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        M117 Retracting...
        G91
        G1 E+25 F300
        G1 E-10 F1500
        G1 E-20 F600
        M400
        G4 P3000
        G1 E-100 F300 
        G90
        M400
        M117 Filament ejected.
        M400
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro M109]
rename_existing: M99109
gcode:    
    {% set s = params.S|float %}    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}   
    {% endif %}
    
[gcode_macro M190]
rename_existing: M99190
gcode:    
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}  
    {% endif %}

    
[gcode_macro M600]
gcode:
    PAUSE STATE=filament_change

[gcode_macro UPDATE_LEDS]
description: Updates LED colors based on tool temperature and printing state
gcode:
    {% set tool_nr = printer.toolhead.extruder|default("extruder0") %}
    {% set temp = printer[tool_nr].temperature|default(0) %}
    {% set target = printer[tool_nr].target|default(0) %}
    {% set printing = printer.print_stats.state == "printing" %}

    ; Determine LED color based on conditions
    {% if printing %}
        #M117 Setting LEDs to WHITE (Printing)
        SET_LED LED=T0_hotend_rgb RED={255/255} GREEN={255/255} BLUE={255/255}
        SET_LED LED=T1_hotend_rgb RED={255/255} GREEN={255/255} BLUE={255/255}
    {% elif temp > 40 %}
        #M117 Setting LEDs to RED (Hot Nozzle)
        SET_LED LED=T0_hotend_rgb RED={255/255} GREEN={0/255} BLUE={0/255}
        SET_LED LED=T1_hotend_rgb RED={255/255} GREEN={0/255} BLUE={0/255}
    {% else %}
        #M117 Turning LEDs OFF (Cool Nozzle)
        SET_LED LED=T0_hotend_rgb RED={0/255} GREEN={0/255} BLUE={0/255}
        SET_LED LED=T1_hotend_rgb RED={0/255} GREEN={0/255} BLUE={0/255}
    {% endif %}

    ; Schedule next update in 2 seconds
    UPDATE_DELAYED_GCODE ID=led_update DURATION=2

[gcode_macro FORCE_MOVE_Z]
description: Lower the bed 10mm without homing
gcode:
  G90
  SET_KINEMATIC_POSITION Z=0
  G0 Z10 F600
  M84

#[shaketune]
 #result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
 #number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
 #keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
 #show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
 #timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.