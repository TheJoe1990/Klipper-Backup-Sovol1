# ============================================================
# TOOLLESS_HOME
# ============================================================
[gcode_macro TOOLLESS_HOME]
description: "Toolless Z homing using shuttle tool-probe at the calibration point"
variable_shuttle_tool_number: -100
variable_cp_x: 281.6
variable_cp_y: 326.1
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # This macro homes Z when NO real tool is mounted.
    #
    # Problem:
    # - Your Z endstop is implemented via tool probes.
    # - If no tool is mounted, there is no “active tool probe” unless we pick one.
    #
    # Solution:
    # - Use the shuttle probe (a special tool_probe with a negative tool number).
    # - Temporarily set kinematic Z to position_max so Z moves are allowed.
    # - Move to a known-safe XY calibration point.
    # - Run REAL homing (G28.1 Z) using the shuttle probe as the active probe.
    #
    # Notes:
    # - This macro NEVER calls G28 (the wrapper). It ONLY calls G28.1.
    # - Shuttle tool number is configurable via variable_shuttle_tool_number.
    # =====================================================================

    {% set axes = params.AXIS|default("Z")|string|upper %}
    {% set do_z = (axes == "" or axes == "XYZ" or ("Z" in axes)) %}

    {% if do_z %}
        {% set cp_x = params.X|default(printer["gcode_macro TOOLLESS_HOME"].cp_x)|float %}
        {% set cp_y = params.Y|default(printer["gcode_macro TOOLLESS_HOME"].cp_y)|float %}
        {% set xy_f = params.XY_F|default(12000)|int %}
        {% set z_max = printer.configfile.config["stepper_z"]["position_max"]|float %}
        {% set shuttle = printer["gcode_macro TOOLLESS_HOME"].shuttle_tool_number|int %}

        # Ensure XY is homed using REAL G28.1
        {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes %}
            RESPOND TYPE=echo MSG="TOOLLESS_HOME: XY not homed -> homing XY first (G28.1)"
            G28.1 X Y
        {% endif %}

        # Allow Z motion while unhomed
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: setting temporary Z=stepper_z.position_max ({z_max})"
        SET_KINEMATIC_POSITION Z={z_max}

        # Select shuttle probe as active
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: selecting shuttle tool probe (T={shuttle})"
        SET_ACTIVE_TOOL_PROBE T={shuttle}
        G4 P100

        # Move to calibration point and home Z with REAL G28.1
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: moving to calibration probe X{cp_x} Y{cp_y}"
        G90
        G0 X{cp_x} Y{cp_y} F{xy_f}

        RESPOND TYPE=echo MSG="TOOLLESS_HOME: G28.1 Z using shuttle probe"
        G28.1 Z

        {% if "gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET" in printer %}
            _ADJUST_Z_HOME_FOR_TOOL_OFFSET
        {% endif %}
    {% else %}
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: Z not requested."
    {% endif %}


# ============================================================
# G28 (WRAPPER) — PHASE A: DETECT, THEN HAND OFF TO ROUTER
# ============================================================
[gcode_macro G28]
description: "Wrapper: detect tool probe then route to tool-present vs toolless homing"
rename_existing: G28.1
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # This macro wraps Klipper’s real homing command.
    #
    # The core gotcha:
    # - Klipper renders ALL Jinja first, then executes gcode.
    # - So you cannot reliably:
    #     DETECT_ACTIVE_TOOL_PROBE
    #     then read active_tool_number
    #   inside the *same* macro and expect the read to reflect detection.
    #
    # Therefore we do this in TWO PHASES:
    #
    # Phase A (THIS macro):
    #   - Parse which axes the user requested.
    #   - Run DETECT_ACTIVE_TOOL_PROBE.
    #   - Call _G28_ROUTE with flags HX/HY/HZ.
    #
    # Phase B (_G28_ROUTE):
    #   - Reads printer.tool_probe_endstop.active_tool_number AFTER detection ran.
    #   - Branches correctly:
    #       detected >= 0  -> real tool -> init toolchanger to that tool + normal homing
    #       detected <  0  -> no tool   -> toolless homing (shuttle) + then INITIALIZE_TOOLCHANGER
    #
    # IMPORTANT RULE YOU GAVE:
    # - INITIALIZE_TOOLCHANGER MUST run after toolless homing so you can select tools.
    #   We do that in the toolless branch of _G28_ROUTE.
    # =====================================================================

    {% set p = params|default({}) %}
    {% set home_all = ('X' not in p and 'Y' not in p and 'Z' not in p) %}
    {% set hx = 1 if (home_all or ('X' in p)) else 0 %}
    {% set hy = 1 if (home_all or ('Y' in p)) else 0 %}
    {% set hz = 1 if (home_all or ('Z' in p)) else 0 %}

    # Clear offsets before any homing decisions
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # Let MCUs settle after restart/boot
    G4 P250

    # Phase A: detect which probe is open (sets active_tool_number internally)
    DETECT_ACTIVE_TOOL_PROBE

    # Phase B: route using the updated state
    _G28_ROUTE HX={hx} HY={hy} HZ={hz}


# ============================================================
# _G28_ROUTE — PHASE B: BRANCHING THAT ACTUALLY WORKS
# ============================================================
[gcode_macro _G28_ROUTE]
description: "Internal: route homing after DETECT_ACTIVE_TOOL_PROBE (do not call directly)"
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # This macro is called ONLY by the G28 wrapper, after detection ran.
    #
    # It reads:
    #   printer.tool_probe_endstop.active_tool_number
    #
    # Meaning:
    # - >= 0 : a REAL tool probe is open -> a real tool is mounted
    # - <  0 : no real tool probe open   -> toolless mode (shuttle probe)
    #
    # Tool-present path:
    # - INITIALIZE_TOOLCHANGER T={detected}
    # - Home requested axes using REAL G28.1
    #
    # Toolless path:
    # - Home XY using your existing pattern (Y then sensorless X).
    # - Home Z via TOOLLESS_HOME (shuttle).
    # - THEN run INITIALIZE_TOOLCHANGER (no T) so you can select tools afterward.
    #
    # This macro NEVER calls G28. It ONLY calls G28.1 and TOOLLESS_HOME.
    # =====================================================================

    {% set hx = params.HX|default(0)|int %}
    {% set hy = params.HY|default(0)|int %}
    {% set hz = params.HZ|default(0)|int %}

    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    {% set detected = -1 %}
    {% if 'tool_probe_endstop' in printer %}
        {% set detected = printer.tool_probe_endstop.active_tool_number|default(-1)|int %}
    {% endif %}

    RESPOND TYPE=echo MSG="_G28_ROUTE: detected_tool={detected}"

    # ============================
    # TOOLLESS (any negative)
    # ============================
    {% if detected < 0 %}
        RESPOND TYPE=echo MSG="G28: no real tool -> toolless"

        # Y first (required for your X sensorless pattern)
        {% if hy or hx %}
            G28.1 Y
        {% endif %}

        # X sensorless routine (your existing motion pattern)
        {% if hx %}
            G90
            G0 Y{ max_y - 175 } F5000
            _SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28.1 Y
        {% endif %}

        # Z via shuttle probe
        {% if hz %}
            TOOLLESS_HOME AXIS=Z
        {% endif %}

        # CRITICAL: bring toolchanger into a known state AFTER toolless homing
        # so tool selection works.
        {% if "gcode_macro INITIALIZE_TOOLCHANGER" in printer %}
            RESPOND TYPE=echo MSG="G28: post-toolless INITIALIZE_TOOLCHANGER (enables tool selection)"
            INITIALIZE_TOOLCHANGER
        {% endif %}
    {% endif %}

    # ============================
    # TOOL PRESENT (>= 0)
    # ============================
    {% if detected >= 0 %}
        RESPOND TYPE=echo MSG="G28: tool present -> normal (T{detected})"

        # Initialize toolchanger to the detected tool
        {% if "gcode_macro INITIALIZE_TOOLCHANGER" in printer %}
            INITIALIZE_TOOLCHANGER T={detected}
        {% endif %}
        STOP_TOOL_PROBE_CRASH_DETECTION

        # Z-first safety (if requested)
        {% if hz %}
            {% if printer.probe.last_query %}
                RESPOND TYPE=error MSG="G28: probe already triggered; refusing to home Z"
                PAUSE
            {% endif %}
            G28.1 Z
            G91
            G0 Z5 F1200
            G90
        {% endif %}

        # Y
        {% if hy or hx %}
            G28.1 Y
        {% endif %}

        # X sensorless
        {% if hx %}
            G90
            G0 Y{ max_y - 175 } F5000
            _SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28.1 Y
        {% endif %}

        # Final Z + offsets (if requested)
        {% if hz %}
            {% set random_x = (range(-50, 50) | random) / 10 %}
            {% set random_y = (range(-50, 50) | random) / 10 %}

            G90
            G0 X{175.0+random_x} Y{175.0+random_y} F12000

            G91
            G0 Z5 F1200
            G90

            G28.1 Z

            G91
            G0 Z5 F1200
            G90

            _ADJUST_Z_HOME_FOR_TOOL_OFFSET
            _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
        {% endif %}
    {% endif %}


# ============================================================
# _SENSORLESS_HOME_X
# ============================================================
[gcode_macro _SENSORLESS_HOME_X]
variable_home_current: 0.5
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # This macro performs sensorless X homing with a reduced motor current,
    # then restores the configured run currents afterward.
    #
    # It calls REAL G28.1 X so it will not recurse through the G28 wrapper.
    # =====================================================================

    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro _SENSORLESS_HOME_X"].home_current}

    G28.1 X

    G91
    G1 X-10 F1200
    G4 P1000

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}


# ============================================================
# _ADJUST_Z_HOME_FOR_TOOL_OFFSET
# ============================================================
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -100
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # After homing Z via a tool probe, Klipper’s internal Z=0 position
    # may need to be corrected because:
    # - each tool can have a different gcode_z_offset
    # - and the active tool probe may have its own z_offset
    #
    # This macro sets kinematic Z so that:
    # - If toolless / shuttle (negative tool number): apply only probe offset
    # - If real tool (>=0): apply tool gcode_z_offset + probe z offset
    #
    # NOTE:
    # - We purposely avoid any RETURN here.
    # =====================================================================

    G90
    G0 Z10 F1000

    {% set shuttle = printer["gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET"].shuttle_tool_number|int %}
    {% set active = (printer.tool_probe_endstop.active_tool_number|default(-1)|int) if 'tool_probe_endstop' in printer else -1 %}
    {% set probe_z_offset = (printer.tool_probe_endstop.active_tool_probe_z_offset|default(0.0)|float) if 'tool_probe_endstop' in printer else 0.0 %}

    {% if active < 0 or active == shuttle %}
        SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset}
    {% else %}
        {% set tool = printer.toolchanger.tool %}
        {% if tool %}
            {% set tool_z_offset = printer[tool].gcode_z_offset|float %}
            SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset + probe_z_offset}
        {% endif %}
    {% endif %}


# ============================================================
# _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
# ============================================================
[gcode_macro _APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Once the toolchanger has an active tool, apply its stored
    # gcode offsets (X/Y/Z) to the live coordinate system.
    #
    # This is separate from kinematic position correction; it’s the
    # “normal” SET_GCODE_OFFSET used for printing.
    # =====================================================================

    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
        SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}


# ============================================================
# TOOL_BED_MESH_CALIBRATE
# ============================================================
[gcode_macro TOOL_BED_MESH_CALIBRATE]
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Bed mesh knows probe offsets, but not per-tool gcode_z_offset.
    # This macro temporarily adjusts kinematic Z so that meshing is done
    # in the correct coordinate frame for the currently mounted tool.
    # =====================================================================

    {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
    G90
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0-tool_z_offset|float}
    BED_MESH_CALIBRATE
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float}


# ============================================================
# TC_DEBUG_LAST_QUERY
# ============================================================
[gcode_macro TC_DEBUG_LAST_QUERY]
description: "Debug: run DETECT and print tool_probe_endstop last_query + active probe"
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # This macro is a safe, non-moving diagnostic:
    # - Runs DETECT_ACTIVE_TOOL_PROBE
    # - Prints which tool probe became active
    # - Prints the last_query map so you can see which probes were triggered
    #
    # Interpretation:
    # - last_query entries are tool_number: triggered_state
    # - 0 means "open" (not triggered) -> candidate for active tool
    # =====================================================================

    {% if 'tool_probe_endstop' in printer %}
        DETECT_ACTIVE_TOOL_PROBE
        {action_respond_info("active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
        {action_respond_info("active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
        {action_respond_info("last_query=" ~ (printer.tool_probe_endstop.last_tools_query|string))}
    {% else %}
        {action_respond_info("tool_probe_endstop NOT present")}
    {% endif %}




[gcode_macro TC_DEBUG_DETECT_TOOL]
description: "Debug: show tool detection state (does not move)"
gcode:
    SET_ACTIVE_TOOL_PROBE T=-1
    DETECT_ACTIVE_TOOL_PROBE
    RESPOND TYPE=echo MSG="probe.active_tool_number={printer.probe.active_tool_number|default('undef')}"
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('undef')}"
    {% else %}
        RESPOND TYPE=echo MSG="tool_probe_endstop not present in printer objects"
    {% endif %}


[gcode_macro _SENSORLESS_HOME_X]
variable_home_current: 0.5
gcode:
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro _SENSORLESS_HOME_X"].home_current}

    G28.1 X

    G91
    G1 X-10 F1200
    G4 P1000

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}


[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -100
gcode:
    G90
    G0 Z10 F1000

    {% set shuttle = printer["gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET"].shuttle_tool_number|int %}
    {% set active = (printer.tool_probe_endstop.active_tool_number|default(-1)|int) if 'tool_probe_endstop' in printer else -1 %}
    {% set probe_z_offset = (printer.tool_probe_endstop.active_tool_probe_z_offset|default(0.0)|float) if 'tool_probe_endstop' in printer else 0.0 %}

    # If we're using shuttle probe / no tool, only apply probe offset
    {% if active < 0 or active == shuttle %}
        SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset}
    {% else %}
        {% set tool = printer.toolchanger.tool %}
        {% if tool %}
            {% set tool_z_offset = printer[tool].gcode_z_offset|float %}
            SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset + probe_z_offset}
        {% endif %}
    {% endif %}



[gcode_macro _APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
gcode:
    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
        SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}


[gcode_macro TOOL_BED_MESH_CALIBRATE]
gcode:
    {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
    G90
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0-tool_z_offset|float}
    BED_MESH_CALIBRATE
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float}




[gcode_macro TC_DEBUG_TOOLPROBE]
gcode:
    {% if 'tool_probe_endstop' not in printer %}
        {action_respond_info("tool_probe_endstop object NOT present")}
        RETURN
    {% endif %}

    {action_respond_info("Before: active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
    {action_respond_info("Before: active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}

    SET_ACTIVE_TOOL_PROBE T=-1
    G4 P50

    {action_respond_info("After:  active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
    {action_respond_info("After:  active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
