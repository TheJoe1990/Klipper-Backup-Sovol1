# ============================================================
# G28 wrapper (tool-aware homing pattern)
# ============================================================
[gcode_macro G28]
description: "Wrapper: detect tool probe and choose normal vs toolless homing"
rename_existing: G28.1
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER (ONLY HERE, PER YOUR RULE)
    #
    # Why this wrapper exists:
    # - In toolchanger land, "G28" is not just homing axes â€” it's also deciding
    #   whether we have a real tool probe available for Z, or we must use the
    #   shuttle/toolless probe workflow.
    #
    # What "tool detection" means here:
    # - tool_probe_endstop can read multiple [tool_probe] endstops and decide
    #   which one is "open" (NOT triggered).
    # - With your Python tweak, negative shuttle probe(s) are ignored in the
    #   "open probes" candidate list, so they don't break detection.
    #
    # Two homing modes:
    #
    # A) TOOL PRESENT (detected_tool >= 0)
    #    Safety objective: avoid collisions with docks/tools when Z height is unknown.
    #
    #    Pattern:
    #      1) Initialize toolchanger to the detected tool (so the correct tool probe is active)
    #      2) Z-FIRST (rough Z home) if Z requested
    #         - establish a known Z reference and get some clearance
    #      3) Home Y if requested (or needed for X)
    #      4) Home X using your sensorless sequence (which assumes Y is homed first)
    #      5) FINAL Z near center if Z requested
    #         - we do a second Z home where you actually want it for printing
    #         - then apply your Z correction macro and tool offsets
    #
    # B) NO TOOL (detected_tool < 0)
    #    Pattern:
    #      1) Home Y (required before your X sensorless routine)
    #      2) Home X (sensorless) using your existing macro path
    #      3) Home Z using TOOLLESS_HOME (which selects shuttle probe and uses G28.1 Z)
    #
    # Key rule:
    # - This macro MUST NEVER call G28 internally except through G28.1 (rename_existing)
    #   or we will recurse and crash.
    #
    # Notes:
    # - If you see "All probes triggered" when a tool is mounted, that's a probe wiring/
    #   polarity/pullup issue for that tool probe.
    # - This wrapper trusts DETECT_ACTIVE_TOOL_PROBE to set tool_probe_endstop.active_tool_number.
    # =====================================================================

    {% set p = params|default({}) %}
    {% set home_all = ('X' not in p and 'Y' not in p and 'Z' not in p) %}
    {% set home_x = home_all or ('X' in p) %}
    {% set home_y = home_all or ('Y' in p) %}
    {% set home_z = home_all or ('Z' in p) %}

    # Always clear offsets before homing decisions
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # Used by your X sensorless routine
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    # Give MCUs a moment after reboot / restart before reading probe states
    G4 P250

    # Detect tool probe state (doesn't require a probe to already be "active")
    DETECT_ACTIVE_TOOL_PROBE

    {% set detected = -1 %}
    {% if 'tool_probe_endstop' in printer %}
        {% set detected = printer.tool_probe_endstop.active_tool_number|default(-1)|int %}
    {% endif %}

    RESPOND TYPE=echo MSG="G28: detected_tool={detected}"

    # ============================================================
    # MODE B: NO TOOL -> TOOLLESS pattern
    # ============================================================
    {% if detected < 0 %}
        RESPOND TYPE=echo MSG="G28: no tool -> toolless"

        # Y first (needed for your X sensorless pattern)
        {% if home_y or home_x %}
            G28.1 Y
        {% endif %}

        # X sensorless sequence (your existing logic)
        {% if home_x %}
            G90
            G0 Y{ max_y - 175 } F5000
            _SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28.1 Y
        {% endif %}

        # Z via shuttle/toolless workflow
        {% if home_z %}
            TOOLLESS_HOME AXIS=Z
        {% endif %}

        RETURN
    {% endif %}

    # ============================================================
    # MODE A: TOOL PRESENT -> Z-first safety pattern
    # ============================================================
    RESPOND TYPE=echo MSG="G28: tool present -> normal (T{detected})"

    _INITIALIZE_FROM_DETECTED_TOOL
    STOP_TOOL_PROBE_CRASH_DETECTION

    # ---- Z FIRST (rough) ----
    {% if home_z %}
        {% if printer.probe.last_query %}
            RESPOND TYPE=error MSG="G28: probe already triggered; refusing to home Z"
            PAUSE
        {% endif %}
        G28.1 Z
        G91
        G0 Z5 F1200
        G90
    {% endif %}

    # ---- Y ----
    {% if home_y or home_x %}
        G28.1 Y
    {% endif %}

    # ---- X sensorless ----
    {% if home_x %}
        G90
        G0 Y{ max_y - 175 } F5000
        _SENSORLESS_HOME_X
        G91
        G0 X-10 F5000
        G0 X-165 F5000
        G90
        G28.1 Y
    {% endif %}

    # ---- Final Z near center ----
    {% if home_z %}
        {% set random_x = (range(-50, 50) | random) / 10 %}
        {% set random_y = (range(-50, 50) | random) / 10 %}

        G90
        G0 X{175.0+random_x} Y{175.0+random_y} F12000

        G91
        G0 Z5 F1200
        G90

        G28.1 Z

        G91
        G0 Z5 F1200
        G90

        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
        _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
    {% endif %}


[gcode_macro TOOLLESS_HOME]
description: "Toolless homing using shuttle tool-probe (T=-100) at the calibration probe"
gcode:
    {% set axes = params.AXIS|default("Z")|string|upper %}
    {% set home_all = (axes == "" or axes == "XYZ") %}
    {% set do_z = home_all or ("Z" in axes) %}

    {% if not do_z %}
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: Z not requested."
        RETURN
    {% endif %}

    {% set cp_x = params.X|default(281.6)|float %}
    {% set cp_y = params.Y|default(326.1)|float %}
    {% set xy_f = params.XY_F|default(12000)|int %}
    {% set z_max = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Ensure XY is homed using the REAL G28 (G28.1)
    {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes %}
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: XY not homed -> homing XY first (G28.1)"
        G28.1 X Y
    {% endif %}

    # Allow Z motion while unhomed
    RESPOND TYPE=echo MSG="TOOLLESS_HOME: setting temporary Z=stepper_z.position_max ({z_max})"
    SET_KINEMATIC_POSITION Z={z_max}

    # Select shuttle probe as active (T=-100)
    RESPOND TYPE=echo MSG="TOOLLESS_HOME: selecting shuttle tool probe (T=-100)"
    SET_ACTIVE_TOOL_PROBE T=-100
    G4 P100

    # Move to the calibration probe XY and home Z with REAL G28.1
    RESPOND TYPE=echo MSG="TOOLLESS_HOME: moving to calibration probe X{cp_x} Y{cp_y}"
    G90
    G0 X{cp_x} Y{cp_y} F{xy_f}

    RESPOND TYPE=echo MSG="TOOLLESS_HOME: G28.1 Z using shuttle probe"
    G28.1 Z

    {% if "gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET" in printer %}
        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}

    # Park
    {% set park_x = params.PARK_X|default(175.0)|float %}
    {% set park_y = params.PARK_Y|default(175.0)|float %}
    {% set park_z = params.PARK_Z|default(10.0)|float %}
    G90
    G0 Z{park_z} F12000
    G0 X{park_x} Y{park_y} F{xy_f}



[gcode_macro TC_DEBUG_OPEN_PROBES]
description: "Debug: run DETECT and dump tool_probe_endstop last_query + active probe"
gcode:
  {% if 'tool_probe_endstop' not in printer %}
    {action_respond_info("tool_probe_endstop NOT present")}
    RETURN
  {% endif %}

  {action_respond_info("---- BEFORE ----")}
  {action_respond_info("active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
  {action_respond_info("active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}

  DETECT_ACTIVE_TOOL_PROBE

  {action_respond_info("---- AFTER DETECT ----")}
  {action_respond_info("active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
  {action_respond_info("active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
  {action_respond_info("last_query=" ~ (printer.tool_probe_endstop.last_tools_query|string))}




[gcode_macro TC_DEBUG_LAST_QUERY]
description: "Run DETECT and print last_query map for each tool probe"
gcode:
  {% if 'tool_probe_endstop' not in printer %}
    {action_respond_info("tool_probe_endstop NOT present")}
    RETURN
  {% endif %}

  DETECT_ACTIVE_TOOL_PROBE
  {action_respond_info("active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
  {action_respond_info("active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
  {action_respond_info("last_query=" ~ (printer.tool_probe_endstop.last_tools_query|string))}









[gcode_macro TC_DEBUG_DETECT_TOOL]
description: "Debug: show tool detection state (does not move)"
gcode:
    SET_ACTIVE_TOOL_PROBE T=-1
    DETECT_ACTIVE_TOOL_PROBE
    RESPOND TYPE=echo MSG="probe.active_tool_number={printer.probe.active_tool_number|default('undef')}"
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('undef')}"
    {% else %}
        RESPOND TYPE=echo MSG="tool_probe_endstop not present in printer objects"
    {% endif %}


[gcode_macro _SENSORLESS_HOME_X]
variable_home_current: 0.5
gcode:
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro _SENSORLESS_HOME_X"].home_current}

    G28.1 X

    G91
    G1 X-10 F1200
    G4 P1000

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}


[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -100
gcode:
    G90
    G0 Z10 F1000

    {% if (printer.probe.active_tool_number|default(-999)|int) == shuttle_tool_number %}
        {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
        SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset|float}
    {% else %}
        {% set tool = printer.toolchanger.tool %}
        {% if tool %}
            {% set tool_z_offset = printer[tool].gcode_z_offset %}
            {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
            SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float + probe_z_offset|float}
        {% endif %}
    {% endif %}



[gcode_macro _APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
gcode:
    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
        SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}


[gcode_macro TOOL_BED_MESH_CALIBRATE]
gcode:
    {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
    G90
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0-tool_z_offset|float}
    BED_MESH_CALIBRATE
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float}




[gcode_macro TC_DEBUG_TOOLPROBE]
gcode:
    {% if 'tool_probe_endstop' not in printer %}
        {action_respond_info("tool_probe_endstop object NOT present")}
        RETURN
    {% endif %}

    {action_respond_info("Before: active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
    {action_respond_info("Before: active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}

    SET_ACTIVE_TOOL_PROBE T=-1
    G4 P50

    {action_respond_info("After:  active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
    {action_respond_info("After:  active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
