[homing_override]
axes: xyz
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLANATION (commented)
    #
    # What’s broken right now:
    #   - Your Z endstop is configured as: endstop_pin: probe:z_virtual_endstop
    #   - That means ANY "G28 Z" uses the probe framework.
    #   - In shuttle-only (no tool) mode, your shuttle probe selection ends up as:
    #        active_tool_number = -1
    #        active_tool_probe  = None
    #     so Klipper refuses probe actions with:
    #        "Cannot interact with probe - no active tool probe."
    #
    # What we do here:
    #   - We DO NOT attempt "G28 Z" when no tool is mounted.
    #   - Instead, for tool-less Z we:
    #       1) Home X/Y first (so positioning is safe and deterministic)
    #       2) Move the shuttle to the dome position
    #       3) Use tools_calibrate (PE12 dome) to "tap" / locate the dome
    #          (this is the same mechanism you already use for tool offset calibration)
    #       4) After the tap, we set the printer’s Z position using SET_KINEMATIC_POSITION
    #          so Z becomes "known" WITHOUT using the probe framework.
    #
    # Tool-present path:
    #   - If a tool is detected, we do your normal Z-first approach and we CAN use G28 Z,
    #     because a real tool_probe exists and active_tool_probe is valid.
    #
    # Goal:
    #   - Homing mode depends on physical detection now,
    #     and tool-less Z homing never touches the probe framework.
    # =====================================================================

    {% set p = params|default({}) %}
    {% set home_all = ('X' not in p and 'Y' not in p and 'Z' not in p) %}
    {% set home_x = home_all or ('X' in p) %}
    {% set home_y = home_all or ('Y' in p) %}
    {% set home_z = home_all or ('Z' in p) %}
    {% set z_homed = 'z' in printer.toolhead.homed_axes %}

    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    # --- Tool-less Z dome position (the dome you already use for calibration) ---
    # NOTE: these are the coordinates you were already using.
    {% set dome_x = 281.6 %}
    {% set dome_y = 326.1 %}

    # Reset offsets before any homing logic
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # ------------------------------------------------------
    # TOOL DETECTION (decide tool vs no-tool)
    # ------------------------------------------------------
    # We will:
    #   - Force shuttle probe selection for baseline
    #   - Run DETECT_ACTIVE_TOOL_PROBE
    #   - Trust tool_probe_endstop.active_tool_number for "physical tool present"
    #
    # IMPORTANT:
    #   - This detection does NOT need an active tool_probe object to exist.
    #   - It just tells us if a tool is mounted or not.
    RESPOND TYPE=echo MSG="Homing: selecting shuttle probe (T=-1) for detection"
    SET_ACTIVE_TOOL_PROBE T=-1
    G4 P150
    DETECT_ACTIVE_TOOL_PROBE

    {% set detected = -1 %}
    {% if 'tool_probe_endstop' in printer %}
        {% set detected = printer.tool_probe_endstop.active_tool_number | default(-1) | int %}
    {% endif %}
    RESPOND TYPE=echo MSG="Homing: detected_tool={detected}"

    # ======================================================
    # BRANCH A: TOOL PRESENT (normal tool homing)
    # ======================================================
    {% if detected != -1 %}
        RESPOND TYPE=echo MSG="Tool T{detected} detected → TOOL-PRESENT homing"

        # Initialize toolchanger state from detected tool (so offsets/shapers apply correctly)
        _INITIALIZE_FROM_DETECTED_TOOL
        STOP_TOOL_PROBE_CRASH_DETECTION

        # Safety: If probe is currently triggered, refuse Z homing
        {% if printer.probe.last_query %}
            RESPOND TYPE=error MSG="Homing: probe already triggered; refusing to home Z"
            PAUSE
        {% endif %}

        # Z-first rough home (only if any axis requested)
        {% if home_x or home_y or home_z %}
            {% if z_homed %}
                G91
                G0 Z5 F1200
                G90
            {% endif %}
            G90
            G28 Z
            G91
            G0 Z15 F1200
            G90
        {% endif %}

        # Y then X (your existing pattern)
        {% if home_y or home_x %}
            G90
            G28 Y
        {% endif %}

        {% if home_x %}
            G90
            G0 Y{ max_y - 175 } F5000
            _SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28 Y
        {% endif %}

        # Final precise Z at center (if Z requested)
        {% if home_z %}
            {% set random_x = (range(-50, 50) | random) / 10 %}
            {% set random_y = (range(-50, 50) | random) / 10 %}
            G90
            G0 X{175.0+random_x} Y{175.0+random_y} F12000
            G91
            G0 Z5 F1200
            G90
            G28 Z
            G91
            G0 Z5 F1200
            G90
            _ADJUST_Z_HOME_FOR_TOOL_OFFSET
            _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
        {% endif %}

    # ======================================================
    # BRANCH B: NO TOOL PRESENT (TOOLLESS homing)
    # ======================================================
    {% else %}
        RESPOND TYPE=echo MSG="No tool detected → TOOLLESS homing"

        # Apply shuttle offsets (XY only) for toolless moves
        TC_APPLY_SHUTTLE_OFFSETS

        # Home Y then X (needed before we can move to the dome position safely)
        {% if home_y or home_x %}
            G90
            G28 Y
        {% endif %}

        {% if home_x %}
            G90
            G0 Y{ max_y - 175 } F5000
            _SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28 Y
        {% endif %}

        # TOOLLESS Z HOMING (NO PROBE FRAMEWORK)
        {% if home_z %}
            # Pre-lift only if Z is already homed (avoid "Must home axis first")
            {% if z_homed %}
                G91
                G0 Z5 F1200
                G90
            {% endif %}

            # Move to the dome and use tools_calibrate to tap the dome
            # This avoids G28 Z / probe:z_virtual_endstop entirely.
            RESPOND TYPE=echo MSG="TOOLLESS Z: moving to dome and tapping via tools_calibrate (PE12)"
            G90
            G0 X{dome_x} Y{dome_y} F12000

            # This calls the tools_calibrate routine to physically locate the dome.
            # TOOL_LOCATE_SENSOR is used elsewhere in your calibration flow and works with PE12.
            TOOL_LOCATE_SENSOR

            # After TOOL_LOCATE_SENSOR completes, we must declare Z "known".
            # We treat the dome contact as Z=0 reference, then lift to a safe Z.
            # (If your dome reference isn't Z=0 in your world, we can adjust this constant later.)
            SET_KINEMATIC_POSITION Z=0
            G91
            G0 Z10 F1200
            G90

            # Optional: move to a safer center position after toolless Z
            G0 X175 Y175 F12000

            # If you need your existing offset logic to run after Z is established:
            # (This macro currently expects tool state; for toolless we typically keep offsets cleared.)
            # _ADJUST_Z_HOME_FOR_TOOL_OFFSET
        {% endif %}

    {% endif %}

    # Common cleanup
    M400
    SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
    SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
    SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
    SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1


[gcode_macro TOOLLESS_HOME]
description: "Toolless homing using shuttle dome for Z"
gcode:
    # Home Y first so shuttle can reach switch
    {% set axes = params|default("") %}
    {% set all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}

    # ------------------------------------------------------------------
    # CRITICAL:
    #   Z homing uses the tool-probe framework in this config.
    #   In shuttle-only mode, Klipper may have *no* active tool probe selected,
    #   which causes: "Cannot interact with probe - no active tool probe."
    #
    #   Fix: always force the shuttle probe (T=-1) as active before any Z homing.
    # ------------------------------------------------------------------

    {% if all or 'Y' in axes %}
        G28 Y
        G90
        G0 Y175 F12000
    {% endif %}

    {% if all or 'X' in axes %}
        _SENSORLESS_HOME_X
        G90
        G0 X175 F12000
    {% endif %}

    {% if all or 'Z' in axes %}
        # Force shuttle probe active immediately before Z homing
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: selecting shuttle probe (T=-1) for Z homing"
        _SELECT_SHUTTLE_PROBE_OR_PAUSE


        # Move to shuttle dome position and home Z
        G90
        G0 X281.6 Y326.1 F12000
        G28 Z

        # Post-home moves
        G0 Z10 F12000
        G0 X175 Y175 Z10 F12000

        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}



[gcode_macro TC_DEBUG_DETECT_TOOL]
description: "Debug: show tool detection state (does not move)"
gcode:
    SET_ACTIVE_TOOL_PROBE T=-1
    DETECT_ACTIVE_TOOL_PROBE
    RESPOND TYPE=echo MSG="probe.active_tool_number={printer.probe.active_tool_number|default('undef')}"
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('undef')}"
    {% else %}
        RESPOND TYPE=echo MSG="tool_probe_endstop not present in printer objects"
    {% endif %}



# ================================================================
# [homing_override] — DEPRECATED / DISABLED on 2025-12-10
# Reason for removal:
#     This homing strategy always homed Y → X first, regardless of
#     tool state. When a tool was on the shuttle AND the gantry was
#     high, the XY moves caused collisions that knocked tools off
#     the docks. We have moved to a Z-first strategy when a tool is
#     detected to avoid collisions.
#
# This entire block is preserved ONLY for reference.
# ================================================================

# [homing_override]
# axes: xyz
# gcode:
#     # Figure out what the user actually asked to home
#     {% set p = params|default({}) %}
#     {% set home_all = ('X' not in p and 'Y' not in p and 'Z' not in p) %}
#     {% set want_z = home_all or ('Z' in p) %}
#
#     # ------------------------------------------------------------------
#     # 1) ALWAYS HOME Y FIRST, THEN X (SENSORLESS), NO MATTER WHAT
#     # ------------------------------------------------------------------
#     SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
#     {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
#
#     G90
#     G28 Y
#
#     G90
#     G0 Y{ max_y - 175 } F5000
#     _SENSORLESS_HOME_X
#     G91
#     G0 X-10 F5000
#     G0 X-165 F5000
#     G28 Y
#
#     # If the user only asked for X/Y, stop here
#     {% if not want_z %}
#         RESPOND TYPE=echo MSG="Homing complete: Y & X done; Z skipped per request"
#         M400
#         SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
#         SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
#         SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
#         SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1
#         RETURN
#     {% endif %}
#
#     # ------------------------------------------------------------------
#     # 2) PREP TOOL-PROBE STATE & DETECT WHAT'S ON THE SHUTTLE
#     # ------------------------------------------------------------------
#     {% set atn = printer.probe.active_tool_number | default(-1) | int %}
#     {% if atn == -1 %}
#         # Use shuttle probe as baseline if nothing is active
#         RESPOND TYPE=echo MSG="No active tool probe; selecting shuttle probe (T=-1) for detection"
#         SET_ACTIVE_TOOL_PROBE T=-1
#     {% endif %}
#
#     DETECT_ACTIVE_TOOL_PROBE
#     {% set detected = printer.probe.active_tool_number | int %}
#
#     # ------------------------------------------------------------------
#     # 3) Z HOMING BRANCH: TOOLLESS VS TOOL
#     # ------------------------------------------------------------------
#
#     {% if detected == -1 %}
#         # ----------------------------
#         # NOTHING ON SHUTTLE → TOOLLESS Z HOMING
#         # ----------------------------
#         RESPOND TYPE=echo MSG="DETECT_ACTIVE_TOOL_PROBE: no tool found → toolless Z homing"
#         # Call your toolless routine *just for Z*
#         TOOLLESS_HOME Z=1
#         RETURN
#
#     {% else %}
#         # ----------------------------
#         # TOOL DETECTED → NORMAL Z HOMING
#         # ----------------------------
#         _INITIALIZE_FROM_DETECTED_TOOL
#         STOP_TOOL_PROBE_CRASH_DETECTION
#
#         {% if printer.probe.last_query %}
#             RESPOND TYPE=echo MSG='Z Probe triggered, cannot home.'
#         {% else %}
#             {% set random_x = (range(-50, 50) | random) / 10 %}
#             {% set random_y = (range(-50, 50) | random) / 10 %}
#
#             G90
#             G0 X{175.0+random_x} Y{175.0+random_y} F12000
#             G28 Z
#             _ADJUST_Z_HOME_FOR_TOOL_OFFSET
#
#             _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
#             M400
#             SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
#             SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
#             SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
#             SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1
#         {% endif %}
#     {% endif %}
# ================================================================
# END OF DEPRECATED BLOCK — 2025-12-10
# ================================================================


[gcode_macro _SENSORLESS_HOME_X]
variable_home_current: 0.5
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}    
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro _SENSORLESS_HOME_X"].home_current}

    # Home
    G28 X
    # Move away
    G91
    G1 X-10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

; Depending on the selected tool at the time of homing, the physical Z endstop position is offset.
; This corrects for that using current tool offset.
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
gcode:
      G90 ; absolute mode
      G0 Z10 F1000
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float+probe_z_offset|float}
      {% endif %}

[gcode_macro _APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
gcode:
    ; Apply gcode offsets
    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
      SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}

[gcode_macro TOOL_BED_MESH_CALIBRATE]
gcode:
      {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
      G90 ; absolute mode
      G0 Z10 F1000
      # Bed mesh knows about the probe offset, but not about the tool offset.
      SET_KINEMATIC_POSITION Z={10.0-tool_z_offset|float}
      BED_MESH_CALIBRATE
      G0 Z10 F1000
      SET_KINEMATIC_POSITION Z={10.0+tool_z_offset|float}

# ---------------------------------------------------------------------
# _HOME macro – decides between toolless and normal homing
# ---------------------------------------------------------------------
[gcode_macro TOOLLESS_HOME]
gcode:
    # Home Y first so shuttle can reach switch
    {% set axes = params|default("") %}
    {% set all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}

    # Optional: use the shuttle probe tool
    SET_ACTIVE_TOOL_PROBE T=-1

    {% if all or 'Y' in axes %}
        G28 Y
        G90
        G0 Y175 F12000
    {% endif %}

    {% if all or 'X' in axes %}
        _SENSORLESS_HOME_X
        G90
        G0 X175 F12000
    {% endif %}

    {% if all or 'Z' in axes %}
        G90
        G0 X281.6 Y326.1 F12000
        G28 Z
        G0 Z10 F12000
        G0 X175 Y175 Z10 F12000
        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}



[gcode_macro TC_SELECT_DETECTION_PROBE]
description: "Select a usable active tool probe for detection; prefer shuttle (T=-1)"
gcode:
  {% set tpe = printer.printer.lookup_object('tool_probe_endstop', None) %}
  {% if not tpe %}
    RESPOND TYPE=error MSG="TC_SELECT_DETECTION_PROBE: tool_probe_endstop not found"
    PAUSE
  {% endif %}

  {% set open_tools = tpe._query_open_tools()|list %}
  RESPOND TYPE=echo MSG="TC_SELECT_DETECTION_PROBE: open_probes={open_tools|length}"

  # Prefer shuttle probe if it is open/available
  {% set shuttle = None %}
  {% for p in open_tools %}
    {% if p.tool|int == -1 %}
      {% set shuttle = p %}
    {% endif %}
  {% endfor %}

  {% if shuttle %}
    RESPOND TYPE=echo MSG="TC_SELECT_DETECTION_PROBE: selecting shuttle probe (T=-1)"
    {% set _ = tpe.set_active_probe(shuttle) %}
  {% elif open_tools|length == 1 %}
    RESPOND TYPE=echo MSG="TC_SELECT_DETECTION_PROBE: selecting only open probe (T={open_tools[0].tool})"
    {% set _ = tpe.set_active_probe(open_tools[0]) %}
  {% else %}
    RESPOND TYPE=error MSG="TC_SELECT_DETECTION_PROBE: cannot choose probe (open_probes={open_tools|length}). Check shuttle probe pin state."
    PAUSE
  {% endif %}

  RESPOND TYPE=echo MSG="TC_SELECT_DETECTION_PROBE: active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('None')}, active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
