# ============================================================
# TOOLLESS_HOME
# ============================================================
[gcode_macro TOOLLESS_HOME]
description: "Plain English: Toolless Z homing. Uses shuttle probe tool=-100, moves to cp_x/cp_y, then runs G28.1 Z and fixes kinematic Z."
variable_shuttle_tool_number: -100
variable_cp_x: 281.6
variable_cp_y: 326.1
gcode:
    {% set axes = params.AXIS|default("Z")|string|upper %}
    {% set do_z = (axes == "" or axes == "XYZ" or ("Z" in axes)) %}

    {% if do_z %}
        {% set cp_x = params.X|default(printer["gcode_macro TOOLLESS_HOME"].cp_x)|float %}
        {% set cp_y = params.Y|default(printer["gcode_macro TOOLLESS_HOME"].cp_y)|float %}
        {% set xy_f = params.XY_F|default(12000)|int %}
        {% set z_max = printer.configfile.config["stepper_z"]["position_max"]|float %}
        {% set shuttle = printer["gcode_macro TOOLLESS_HOME"].shuttle_tool_number|int %}

        {% if "x" not in printer.toolhead.homed_axes or "y" not in printer.toolhead.homed_axes %}
            RESPOND TYPE=echo MSG="TOOLLESS_HOME: XY not homed -> homing XY first (G28.1)"
            G28.1 X Y
        {% endif %}

        RESPOND TYPE=echo MSG="TOOLLESS_HOME: temp Z=position_max ({z_max})"
        SET_KINEMATIC_POSITION Z={z_max}

        RESPOND TYPE=echo MSG="TOOLLESS_HOME: SET_ACTIVE_TOOL_PROBE T={shuttle}"
        SET_ACTIVE_TOOL_PROBE T={shuttle}
        G4 P100

        RESPOND TYPE=echo MSG="TOOLLESS_HOME: move to X{cp_x} Y{cp_y}"
        G90
        G0 X{cp_x} Y{cp_y} F{xy_f}

        RESPOND TYPE=echo MSG="TOOLLESS_HOME: G28.1 Z"
        G28.1 Z

        ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% else %}
        RESPOND TYPE=echo MSG="TOOLLESS_HOME: Z not requested."
    {% endif %}


# ============================================================
# G28 (WRAPPER) — PHASE A
# ============================================================
[gcode_macro G28]
description: "Plain English: Wrapper for homing. Detects which tool probe is open, then routes to tool-present or toolless logic."
rename_existing: G28.1
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER  (ONLY HERE — per your rule)
    #
    # Problem:
    # - On boot, Klipper does not know which tool is mounted.
    # - Your Z endstop is provided by the *currently active tool probe*.
    #
    # Detection:
    # - DETECT_ACTIVE_TOOL_PROBE queries all tool probes and finds the one
    #   that is NOT triggered (“open”). That open probe corresponds to the
    #   mounted tool.
    #
    # Special case:
    # - Shuttle probe uses tool number -100.
    # - Any detected tool number < 0 means “no real tool mounted”.
    #
    # Why 2-phase:
    # - We run DETECT_ACTIVE_TOOL_PROBE first,
    # - then we call a second macro to read the updated
    #   tool_probe_endstop.active_tool_number and branch.
    #
    # Your critical rule:
    # - INITIALIZE_TOOLCHANGER must happen AFTER toolless homing,
    #   so you can select tools afterward.
    #
    # Naming gotcha:
    # - Klipper won’t register custom commands that look like real G-codes.
    #   So we do NOT name the router "G28_ROUTE" (invalid).
    #   We name it "TC_HOME_ROUTE" (valid).
    # =====================================================================

    {% set p = params|default({}) %}
    {% set home_all = ('X' not in p and 'Y' not in p and 'Z' not in p) %}
    {% set hx = 1 if (home_all or ('X' in p)) else 0 %}
    {% set hy = 1 if (home_all or ('Y' in p)) else 0 %}
    {% set hz = 1 if (home_all or ('Z' in p)) else 0 %}

    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    G4 P250
    DETECT_ACTIVE_TOOL_PROBE

    TC_HOME_ROUTE HX={hx} HY={hy} HZ={hz}


# ============================================================
# TC_HOME_ROUTE — PHASE B
# ============================================================
[gcode_macro TC_HOME_ROUTE]
description: "Plain English: Called by G28 after DETECT. If detected>=0: init toolchanger + normal homing. If detected<0: toolless homing then INITIALIZE_TOOLCHANGER."
gcode:
    {% set hx = params.HX|default(0)|int %}
    {% set hy = params.HY|default(0)|int %}
    {% set hz = params.HZ|default(0)|int %}

    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    {% set detected = -1 %}
    {% if 'tool_probe_endstop' in printer %}
        {% set detected = printer.tool_probe_endstop.active_tool_number|default(-1)|int %}
    {% endif %}

    RESPOND TYPE=echo MSG="TC_HOME_ROUTE: detected_tool={detected}"

    {% if detected < 0 %}
        RESPOND TYPE=echo MSG="G28: no real tool -> toolless"

        {% if hy or hx %}
            G28.1 Y
        {% endif %}

        {% if hx %}
            G90
            G0 Y{ max_y - 175 } F5000
            SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28.1 Y
        {% endif %}

        {% if hz %}
            TOOLLESS_HOME AXIS=Z
        {% endif %}

        RESPOND TYPE=echo MSG="G28: post-toolless INITIALIZE_TOOLCHANGER"
        INITIALIZE_TOOLCHANGER
    {% else %}
        RESPOND TYPE=echo MSG="G28: tool present -> normal (T{detected})"

        INITIALIZE_TOOLCHANGER T={detected}
        STOP_TOOL_PROBE_CRASH_DETECTION

        {% if hz %}
            {% if printer.probe.last_query %}
                RESPOND TYPE=error MSG="G28: probe already triggered; refusing to home Z"
                PAUSE
            {% endif %}
            G28.1 Z
            G91
            G0 Z5 F1200
            G90
        {% endif %}

        {% if hy or hx %}
            G28.1 Y
        {% endif %}

        {% if hx %}
            G90
            G0 Y{ max_y - 175 } F5000
            SENSORLESS_HOME_X
            G91
            G0 X-10 F5000
            G0 X-165 F5000
            G90
            G28.1 Y
        {% endif %}

        {% if hz %}
            {% set random_x = (range(-50, 50) | random) / 10 %}
            {% set random_y = (range(-50, 50) | random) / 10 %}

            G90
            G0 X{175.0+random_x} Y{175.0+random_y} F12000

            G91
            G0 Z5 F1200
            G90

            G28.1 Z

            G91
            G0 Z5 F1200
            G90

            ADJUST_Z_HOME_FOR_TOOL_OFFSET
            APPLY_ACTIVE_TOOL_GCODE_OFFSETS
        {% endif %}
    {% endif %}


# ============================================================
# SENSORLESS_HOME_X
# ============================================================
[gcode_macro SENSORLESS_HOME_X]
description: "Plain English: Sensorless X homing at reduced current, then restore configured currents. Calls G28.1 X to avoid recursion."
variable_home_current: 0.5
gcode:
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro SENSORLESS_HOME_X"].home_current}

    G28.1 X

    G91
    G1 X-10 F1200
    G4 P1000

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}


# ============================================================
# ADJUST_Z_HOME_FOR_TOOL_OFFSET
# ============================================================
[gcode_macro ADJUST_Z_HOME_FOR_TOOL_OFFSET]
description: "Plain English: After probing Z, correct kinematic Z using probe z_offset + (tool gcode_z_offset if real tool). Treats tool<0 (incl -100) as toolless."
variable_shuttle_tool_number: -100
gcode:
    G90
    G0 Z10 F1000

    {% set shuttle = printer["gcode_macro ADJUST_Z_HOME_FOR_TOOL_OFFSET"].shuttle_tool_number|int %}
    {% set active = (printer.tool_probe_endstop.active_tool_number|default(-1)|int) if 'tool_probe_endstop' in printer else -1 %}
    {% set probe_z_offset = (printer.tool_probe_endstop.active_tool_probe_z_offset|default(0.0)|float) if 'tool_probe_endstop' in printer else 0.0 %}

    {% if active < 0 or active == shuttle %}
        SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset}
    {% else %}
        {% set tool = printer.toolchanger.tool %}
        {% if tool %}
            {% set tool_z_offset = printer[tool].gcode_z_offset|float %}
            SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset + probe_z_offset}
        {% endif %}
    {% endif %}


# ============================================================
# APPLY_ACTIVE_TOOL_GCODE_OFFSETS
# ============================================================
[gcode_macro APPLY_ACTIVE_TOOL_GCODE_OFFSETS]
description: "Plain English: Applies the active tool's stored X/Y/Z offsets using SET_GCODE_OFFSET."
gcode:
    {% set tool = printer.toolchanger.tool %}
    {% if tool %}
        SET_GCODE_OFFSET X={printer[tool].gcode_x_offset} Y={printer[tool].gcode_y_offset} Z={printer[tool].gcode_z_offset}
    {% endif %}


# ============================================================
# TOOL_BED_MESH_CALIBRATE
# ============================================================
[gcode_macro TOOL_BED_MESH_CALIBRATE]
description: "Plain English: Runs BED_MESH_CALIBRATE while temporarily shifting kinematic Z so mesh accounts for current tool gcode_z_offset."
gcode:
    {% set tool_z_offset = printer[printer.toolchanger.tool].gcode_z_offset %}
    G90
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0 - tool_z_offset|float}
    BED_MESH_CALIBRATE
    G0 Z10 F1000
    SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float}


# ============================================================
# TC_DEBUG_LAST_QUERY
# ============================================================
[gcode_macro TC_DEBUG_LAST_QUERY]
description: "Plain English: Runs DETECT_ACTIVE_TOOL_PROBE and prints active tool + last_query map (tool_number: triggered_state)."
gcode:
    {% if 'tool_probe_endstop' in printer %}
        DETECT_ACTIVE_TOOL_PROBE
        {action_respond_info("active_tool_number=" ~ printer.tool_probe_endstop.active_tool_number|string)}
        {action_respond_info("active_tool_probe=" ~ (printer.tool_probe_endstop.active_tool_probe|string))}
        {action_respond_info("last_query=" ~ (printer.tool_probe_endstop.last_tools_query|string))}
    {% else %}
        {action_respond_info("tool_probe_endstop NOT present")}
    {% endif %}


# ============================================================
# TC_DEBUG_DETECT_TOOL
# ============================================================
[gcode_macro TC_DEBUG_DETECT_TOOL]
description: "Plain English: Prints tool_probe_endstop detection result (no motion)."
gcode:
    {% if 'tool_probe_endstop' in printer %}
        DETECT_ACTIVE_TOOL_PROBE
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="tool_probe_endstop.active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('None')}"
    {% else %}
        RESPOND TYPE=echo MSG="tool_probe_endstop not present in printer objects"
    {% endif %}


