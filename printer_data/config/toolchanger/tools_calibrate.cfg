[tools_calibrate]
pin: PE12

# XY probing / motion behavior
travel_speed: 100          # how fast to move while probing XY
spread: 10                 # XY distance from center during probing

# Z probing behavior
lower_z: 0.1               # how far below the pin tip we drive the nozzle
speed: 2.5                 # Z speed while probing
lift_speed: 4              # Z lift after each probe
final_lift_z: 4            # final Z lift after calibration

# Sampling behavior
sample_retract_dist: 2
samples_tolerance: 0.05
samples: 3
samples_result: median

# Nozzle–probe calibration settings (for using the built-in Z probe)
probe: probe               # name of your nozzle probe
trigger_to_bottom_z: 3     # distance from probe trigger to mechanical stop

[gcode_macro CALIBRATE_MOVE_OVER_PROBE]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    BED_MESH_CLEAR
    G90
    G0 Z3 F10000
    G0 X282.5 Y353 F10000  # your probe position

[gcode_macro CALIBRATE_TOOL_OFFSETS]
description: "Calibrate XY offsets between tools (uses KOMB + live offset update)"
# ----------------------------------------------------------------------
# FLOW SUMMARY:
# - Picks the "service tool" (PHYSICAL) from TC_SERVICE_TOOL.service_tool.
# - Determines which tools will be used for this print:
#     * Prefer _START_PRINT.tools_used_during_print
#     * Fallback to Orca Tn_TEMP params
#     * Fallback to "all tools" if nothing is detected
# - For the baseline service tool:
#     * SELECT_TOOL PHYSICAL=service_tool
#     * Heat to that tool's idle temp from Orca
#     * KOMB brush
#     * CALIBRATE_MOVE_OVER_PROBE
#     * TOOL_LOCATE_SENSOR   (tools_calibrate baseline)
#     * _TC_UPDATE_OFFSETS BASELINE=1 T=service_tool
# - For each other tool that needs calibration:
#     * SELECT_TOOL PHYSICAL=Tn
#     * Heat to that tool's idle temp from Orca
#     * KOMB brush
#     * CALIBRATE_MOVE_OVER_PROBE
#     * TOOL_CALIBRATE_TOOL_OFFSET
#     * _TC_UPDATE_OFFSETS T=n  (apply/store offsets)
# - Uses Orca's *_IDLE_TEMP for brushing/calibration temps where available.
# ----------------------------------------------------------------------
gcode:
    {% set tc        = printer.toolchanger %}
    {% set svc       = printer["gcode_macro TC_SERVICE_TOOL"] %}
    {% set svc_tool  = svc.service_tool|int %}
    {% set tools     = range(svc.min_tool|int, svc.max_tool|int + 1) %}
    {% set sp        = printer["gcode_macro _START_PRINT"] if "gcode_macro _START_PRINT" in printer else None %}
    {% set ns        = namespace(used_tools=[]) %}

    # --- Determine which tools we should calibrate ---
    # Prefer tools_used_during_print from _START_PRINT
    {% if sp and sp.tools_used_during_print|length > 0 %}
        {% for tn in sp.tools_used_during_print %}
            {% if tn in tools %}
                {% set _ = ns.used_tools.append(tn) %}
            {% endif %}
        {% endfor %}
    {% else %}
        # Fallback: infer from Orca's Tn_TEMP params
        {% for tn in tools %}
            {% set key = 'T' ~ tn ~ '_TEMP' %}
            {% if key in params and params[key]|float > 0 %}
                {% set _ = ns.used_tools.append(tn) %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if ns.used_tools|length == 0 %}
        # Final fallback: calibrate all tools we know about
        {% for tn in tools %}
            {% set _ = ns.used_tools.append(tn) %}
        {% endfor %}
    {% endif %}

    # Ensure baseline service tool is included in the calibration set
    {% if svc_tool not in ns.used_tools %}
        {% set _ = ns.used_tools.append(svc_tool) %}
    {% endif %}

    { action_respond_info(
        "CALIBRATE_TOOL_OFFSETS: service (baseline) PHYSICAL T" ~ svc_tool ~
        ", calibrating tools: " ~ ns.used_tools|join(", ")
    ) }

    # Helper: compute idle temp for a given tool from Orca params
    {% macro idle_temp_for(tn) -%}
        {% set idle_key = 'T' ~ tn ~ '_IDLE_TEMP' %}
        {% set temp_key = 'T' ~ tn ~ '_TEMP' %}

        {% if idle_key in params %}
            {{ params[idle_key]|int }}
        {% elif temp_key in params %}
            {{ params[temp_key]|int }}
        {% elif 'TOOL_TEMP' in params %}
            {{ params.TOOL_TEMP|int }}
        {% else %}
            {{ 200 }}
        {% endif %}
    {%- endmacro %}


    # ------------------------------------------------------------------
    # 1) Baseline: PHYSICAL service tool (default PHYSICAL T0)
    # ------------------------------------------------------------------
    SELECT_TOOL PHYSICAL={svc_tool}
    {% set base_idle = idle_temp_for(svc_tool) %}
    M109 S{base_idle}           ; heat baseline tool to idle temp

    { action_respond_info(
        "CALIBRATE_TOOL_OFFSETS: baselining PHYSICAL T" ~ svc_tool ~
        " at " ~ base_idle ~ "C"
    ) }

    CALIBRATE_MOVE_OVER_PROBE
    KOMB
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR          ; tools_calibrate sets baseline for service tool
    _TC_UPDATE_OFFSETS T={svc_tool} BASELINE=1

    # ------------------------------------------------------------------
    # 2) Other tools: offsets vs baseline service tool
    # ------------------------------------------------------------------
    {% for tn in ns.used_tools %}
        {% if tn == svc_tool %}
            {% continue %}
        {% endif %}

        SELECT_TOOL PHYSICAL={tn}
        {% set idle = idle_temp_for(tn) %}
        M109 S{idle}

        { action_respond_info(
            "CALIBRATE_TOOL_OFFSETS: calibrating PHYSICAL T" ~ tn ~
            " vs PHYSICAL T" ~ svc_tool ~ " at " ~ idle ~ "C"
        ) }

        CALIBRATE_MOVE_OVER_PROBE
        KOMB
        CALIBRATE_MOVE_OVER_PROBE
        TOOL_CALIBRATE_TOOL_OFFSET    ; tools_calibrate computes offset vs baseline
        _TC_UPDATE_OFFSETS T={tn}
    {% endfor %}



[gcode_macro CALIBRATE_NOZZLE_PROBE_OFFSET]
description: "Calibrate Z offset between nozzle and bed probe for the active tool"
gcode:
    {% set probe = printer.tool_probe_endstop.active_tool_probe %}
    CALIBRATE_MOVE_OVER_PROBE
    M109 S171           ; heat enough for consistent nozzle shape
    KOMB                ; clean the nozzle first
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    TOOL_CALIBRATE_PROBE_OFFSET PROBE="{probe}"
    M104 S0

[include nozzle_offsets.cfg]

[save_variables]
filename: ~/printer_data/config/toolchanger/nozzle_offsets.cfg


[gcode_macro _TC_UPDATE_OFFSETS]
description: "Save/apply last tools_calibrate result; show old vs new offsets"
# ----------------------------------------------------------------------
# FLOW SUMMARY:
# - Reads last XY/Z result from tools_calibrate (tools_cal.last_result).
# - Two modes:
#   1) BASELINE=1:
#       * Stores the probe position (baseline nozzle location) in
#         save_variables under key 'probe_position'.
#       * Does NOT apply gcode offsets.
#       * tn (T=) is just for logging.
#   2) Per-tool mode (BASELINE=0, default):
#       * Stores this tool's offset vs baseline in save_variables under
#         a per-tool key (e.g. offsets_t1, offsets_t2, etc.).
#       * Applies those offsets immediately to the toolchanger tool object.
# - LOAD_ALL:
#       * Reloads all saved offsets from save_variables and applies them
#         at startup, useful from PRINT_START or startup macro.
# ----------------------------------------------------------------------
variable_rounding: 4
variable_svf_prefix: 'offsets_'
gcode:
    {% set tc        = printer.toolchanger %}
    {% set svc       = printer["gcode_macro TC_SERVICE_TOOL"] if "gcode_macro TC_SERVICE_TOOL" in printer else None %}
    {% set svc_tool  = svc.service_tool|int if svc is not none else 0 %}
    {% set tools_cal = printer.tools_calibrate if 'tools_calibrate' in printer else None %}
    {% if tools_cal is none %}
        { action_respond_info("_TC_UPDATE_OFFSETS: tools_calibrate module not available") }
        RETURN
    {% endif %}

    {% set lr = tools_cal.last_result|default([0.0, 0.0, 0.0]) %}
    {% set lp = tools_cal.last_probe_offset|default(0.0) %}
    {% set sv = printer.save_variables.variables %}
    {% set load_all = 'LOAD_ALL' in params %}
    {% set tn = params.T|default(svc_tool)|int %}
    {% set baseline = params.BASELINE|default(0)|int %}

    {% macro set_tool_offset(tool_num, x=None, y=None, z=None) %}
        {% set tool_name = tc.tool_names[tool_num] %}
        {% set tool_obj  = printer.printer.lookup_object(tool_name, None) %}
        {% if tool_obj %}
            {% if x is not none %}{% set _ = tool_obj.__setattr__('gcode_x_offset', x) %}{% endif %}
            {% if y is not none %}{% set _ = tool_obj.__setattr__('gcode_y_offset', y) %}{% endif %}
            {% if z is not none %}{% set _ = tool_obj.__setattr__('gcode_z_offset', z) %}{% endif %}
        {% endif %}
    {% endmacro %}

    {% macro save_dict(key, d) %}
        {% set existing = sv.get(key, {}).copy() if sv.get(key) is mapping else {} %}
        {% set _ = existing.update(d) %}
        SAVE_VARIABLE VARIABLE={key} VALUE="{existing}"
    {% endmacro %}

    {% if load_all %}
        # Reload saved offsets for all tools (e.g. after restart)
        {% for t in tc.tool_numbers %}
            {% set key    = tc.tool_names[t]|lower|replace('tool ', svf_prefix) %}
            {% set stored = sv.get(key, {}) %}
            {% if stored %}
                {% set x = stored.get('x', 0.0)|float %}
                {% set y = stored.get('y', 0.0)|float %}
                {% set z = stored.get('z', 0.0)|float %}
                { set_tool_offset(t, x, y, z) }
                { action_respond_info(
                    "_TC_UPDATE_OFFSETS LOAD_ALL: T" ~ t ~
                    " X=" ~ x ~ " Y=" ~ y ~ " Z=" ~ z
                ) }
            {% else %}
                { action_respond_info("_TC_UPDATE_OFFSETS LOAD_ALL: no saved offsets for T" ~ t) }
            {% endif %}
        {% endfor %}
        RETURN
    {% endif %}

    {% if tn not in tc.tool_numbers %}
        { action_respond_info("_TC_UPDATE_OFFSETS: invalid tool " ~ tn) }
        RETURN
    {% endif %}

    {% if baseline %}
        # --------------------------------------------------------------
        # BASELINE MODE:
        # Store the probe position from the current calibration as the
        # "baseline tool" (usually PHYSICAL T0, but configurable via
        # TC_SERVICE_TOOL.service_tool).
        # --------------------------------------------------------------
        {% set key     = 'probe_position' %}
        {% set prev    = sv.get(key, {}) %}
        {% set old_x   = prev.get('x', 0.0)|float %}
        {% set old_y   = prev.get('y', 0.0)|float %}
        {% set old_z   = prev.get('z', 0.0)|float %}
        {% set new_x   = lr[0]|float %}
        {% set new_y   = lr[1]|float %}
        {% set new_z   = lr[2]|float %}
        {% set dx      = (new_x - old_x)|float %}
        {% set dy      = (new_y - old_y)|float %}
        {% set dz      = (new_z - old_z)|float %}

        { save_dict(key, {'x': new_x, 'y': new_y, 'z': new_z, 'probe': lp, 'tool': tn}) }

        { action_respond_info(
            "Baseline (probe_position) using PHYSICAL T" ~ tn ~ ": " ~
            "old X=" ~ old_x ~ " Y=" ~ old_y ~ " Z=" ~ old_z ~
            "  ->  new X=" ~ new_x ~ " Y=" ~ new_y ~ " Z=" ~ new_z ~
            "  ΔX=" ~ dx ~ " ΔY=" ~ dy ~ " ΔZ=" ~ dz
        ) }
    {% else %}
        # --------------------------------------------------------------
        # PER-TOOL OFFSET MODE:
        # Apply the last tools_calibrate result as tool offsets for Tn
        # and store them in save_variables for reload.
        # --------------------------------------------------------------
        {% set key     = tc.tool_names[tn]|lower|replace('tool ', svf_prefix) %}
        {% set prev    = sv.get(key, {}) %}
        {% set old_x   = prev.get('x', 0.0)|float %}
        {% set old_y   = prev.get('y', 0.0)|float %}
        {% set old_z   = prev.get('z', 0.0)|float %}
        {% set new_x   = lr[0]|float %}
        {% set new_y   = lr[1]|float %}
        {% set new_z   = lr[2]|float %}
        {% set dx      = (new_x - old_x)|float %}
        {% set dy      = (new_y - old_y)|float %}
        {% set dz      = (new_z - old_z)|float %}

        { save_dict(key, {'x': new_x, 'y': new_y, 'z': new_z, 'probe': lp}) }
        { set_tool_offset(tn, new_x, new_y, new_z) }

        { action_respond_info(
            "T" ~ tn ~ " offsets: " ~
            "old X=" ~ old_x ~ " Y=" ~ old_y ~ " Z=" ~ old_z ~
            "  ->  new X=" ~ new_x ~ " Y=" ~ new_y ~ " Z=" ~ new_z ~
            "  ΔX=" ~ dx ~ " ΔY=" ~ dy ~ " ΔZ=" ~ dz
        ) }
    {% endif %}
    
[gcode_macro TC_CALIBRATION_MODE]
description: "Enable/disable automatic tool offset calibration during HEATSOAK"
variable_enabled: 1
gcode:
    {% if 'ENABLED' in params %}
        {% set new = params.ENABLED|int %}
        SET_GCODE_VARIABLE MACRO=TC_CALIBRATION_MODE VARIABLE=enabled VALUE={new}
        { action_respond_info("TC_CALIBRATION_MODE: enabled=" ~ new) }
    {% else %}
        { action_respond_info("TC_CALIBRATION_MODE currently: " ~ enabled) }
    {% endif %}
