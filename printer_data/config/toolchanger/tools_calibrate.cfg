[tools_calibrate]
pin: PE12

# XY probing / motion behavior
travel_speed: 100          # how fast to move while probing XY
spread: 10                 # XY distance from center during probing

# Z probing behavior
lower_z: 0.1               # how far below the pin tip we drive the nozzle
speed: 2.5                 # Z speed while probing
lift_speed: 4              # Z lift after each probe
final_lift_z: 4            # final Z lift after calibration

# Sampling behavior
sample_retract_dist: 2
samples_tolerance: 0.05
samples: 10
samples_result: median

# Nozzleâ€“probe calibration settings (for using the built-in Z probe)
probe: probe               # name of your nozzle probe
trigger_to_bottom_z: 3     # distance from probe trigger to mechanical stop

[gcode_macro CALIBRATE_MOVE_OVER_PROBE]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    BED_MESH_CLEAR
    G90
    G0 Z3 F10000
    G0 X282.5 Y353 F10000  # your probe position

[gcode_macro CALIBRATE_TOOL_OFFSETS]
description: "Calibrate XY offsets between tools (uses KOMB + live offset update)"
gcode:
    # --- Baseline: T0 ---
    T0
    CALIBRATE_MOVE_OVER_PROBE
    M109 S171           ; heat for KOMB cleaning
    KOMB
    CALIBRATE_MOVE_OVER_PROBE
    M109 S200           ; heat for XY calibration
    TOOL_LOCATE_SENSOR  ; tools_calibrate computes baseline for T0
    _TC_UPDATE_OFFSETS T=0   ; stage/save probe_position baseline

    M104 S0

    # --- Other tools relative to T0 ---
    {% for tool in [1, 2] %}
        T{tool}
        CALIBRATE_MOVE_OVER_PROBE
        M109 S171       ; heat for KOMB
        KOMB
        CALIBRATE_MOVE_OVER_PROBE
        M109 S200       ; heat for XY calibration
        TOOL_CALIBRATE_TOOL_OFFSET   ; tools_calibrate computes offset vs T0
        _TC_UPDATE_OFFSETS T={tool}  ; save+apply offsets for this tool
        M104 S0
    {% endfor %}


[gcode_macro CALIBRATE_NOZZLE_PROBE_OFFSET]
description: "Calibrate Z offset between nozzle and bed probe for the active tool"
gcode:
    {% set probe = printer.tool_probe_endstop.active_tool_probe %}
    CALIBRATE_MOVE_OVER_PROBE
    M109 S171           ; heat enough for consistent nozzle shape
    KOMB                ; clean the nozzle first
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    TOOL_CALIBRATE_PROBE_OFFSET PROBE="{probe}"
    M104 S0

[include nozzle_offsets.cfg]

[save_variables]
filename: ~/printer_data/config/toolchanger/nozzle_offsets.cfg

[gcode_macro _TC_UPDATE_OFFSETS]
description: "Save/apply last tools_calibrate result for a tool, or LOAD_ALL"
variable_rounding: 4
variable_svf_prefix: 'offsets_'
gcode:
    {% set tc = printer.toolchanger %}
    {% set tools_cal = printer.tools_calibrate if 'tools_calibrate' in printer else None %}
    {% if tools_cal is none %}
        { action_respond_info("_TC_UPDATE_OFFSETS: tools_calibrate module not available") }
        RETURN
    {% endif %}

    {% set lr = tools_cal.last_result|default([0.0, 0.0, 0.0]) %}
    {% set lp = tools_cal.last_probe_offset|default(0.0) %}
    {% set load_all = 'LOAD_ALL' in params %}
    {% set tn = params.T|int(0) %}

    {% macro save_dict(key, d) %}
        {% set svf = printer.save_variables.variables %}
        {% set existing = svf.get(key, {}).copy() if svf.get(key) is mapping else {} %}
        {% set _ = existing.update(d) %}
        SAVE_VARIABLE VARIABLE={key} VALUE="{existing}"
    {% endmacro %}

    {% macro set_tool_offset(tool_num, x=None, y=None, z=None) %}
        {% set tool_name = tc.tool_names[tool_num] %}
        {% set tool_obj = printer.printer.lookup_object(tool_name, None) %}
        {% if tool_obj %}
            {% if x is not none %}{% set _ = tool_obj.__setattr__('gcode_x_offset', x) %}{% endif %}
            {% if y is not none %}{% set _ = tool_obj.__setattr__('gcode_y_offset', y) %}{% endif %}
            {% if z is not none %}{% set _ = tool_obj.__setattr__('gcode_z_offset', z) %}{% endif %}
        {% endif %}
    {% endmacro %}

    {% if load_all %}
        # Reload saved offsets for all tools (e.g. after restart)
        {% for t in tc.tool_numbers %}
            {% set key = tc.tool_names[t]|lower|replace('tool ', svf_prefix) %}
            {% set stored = printer.save_variables.variables.get(key, {}) %}
            {% if stored %}
                { set_tool_offset(t, stored.get('x', 0.0), stored.get('y', 0.0), stored.get('z', 0.0)) }
                { action_respond_info("_TC_UPDATE_OFFSETS: loaded T" ~ t ~
                                      " X=" ~ stored.get('x', 0.0) ~
                                      " Y=" ~ stored.get('y', 0.0) ~
                                      " Z=" ~ stored.get('z', 0.0)) }
            {% else %}
                { action_respond_info("_TC_UPDATE_OFFSETS: no stored offsets for T" ~ t) }
            {% endif %}
        {% endfor %}
        RETURN
    {% endif %}

    # Single-tool path (called right after a probe)
    {% if tn not in tc.tool_numbers %}
        { action_respond_info("_TC_UPDATE_OFFSETS: invalid tool " ~ tn) }
        RETURN
    {% endif %}

    {% if tn == 0 %}
        # Save baseline probe position from T0
        {% set sv_key = 'probe_position' %}
        {% set data = {'x': lr[0], 'y': lr[1], 'z': lr[2], 'probe': lp} %}
        { save_dict(sv_key, data) }
        { action_respond_info("_TC_UPDATE_OFFSETS: saved probe baseline from T0 X=" ~ lr[0] ~ " Y=" ~ lr[1] ~ " Z=" ~ lr[2]) }
    {% else %}
        # Save and apply actual tool offsets
        {% set key = tc.tool_names[tn]|lower|replace('tool ', svf_prefix) %}
        {% set offs = {'x': lr[0], 'y': lr[1], 'z': lr[2], 'probe': lp} %}
        { save_dict(key, offs) }
        { set_tool_offset(tn, lr[0], lr[1], lr[2]) }
        { action_respond_info("_TC_UPDATE_OFFSETS: T" ~ tn ~
                              " X=" ~ lr[0] ~ " Y=" ~ lr[1] ~ " Z=" ~ lr[2]) }
    {% endif %}

