[tools_calibrate]
pin: PE12

# XY probing / motion behavior
travel_speed: 100          # how fast to move while probing XY
spread: 10                 # XY distance from center during probing

# Z probing behavior
lower_z: 0.1               # how far below the pin tip we drive the nozzle
speed: 2.5                 # Z speed while probing
lift_speed: 4              # Z lift after each probe
final_lift_z: 4            # final Z lift after calibration

# Sampling behavior
sample_retract_dist: 2
samples_tolerance: 0.05
samples: 10
samples_result: median

# Nozzleâ€“probe calibration settings (for using the built-in Z probe)
probe: probe               # name of your nozzle probe
trigger_to_bottom_z: 3     # distance from probe trigger to mechanical stop

[gcode_macro CALIBRATE_MOVE_OVER_PROBE]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    BED_MESH_CLEAR
    G90
    G0 Z3 F10000
    G0 X282.5 Y353 F10000  # your probe position

[gcode_macro CALIBRATE_TOOL_OFFSETS]
description: "Calibrate XY offsets between tools (uses KOMB for cleaning)"
gcode:
    # --- Baseline: T0 (offsets should be 0 in config) ---
    T0
    CALIBRATE_MOVE_OVER_PROBE
    M109 S171           ; heat for KOMB cleaning (your chosen temp)
    KOMB                ; clean nozzle
    CALIBRATE_MOVE_OVER_PROBE
    M109 S200           ; heat for XY calibration
    TOOL_LOCATE_SENSOR
    M104 S0

    # --- Other tools relative to T0 ---
    {% for tool in [1, 2] %}
        T{tool}
        CALIBRATE_MOVE_OVER_PROBE
        M109 S171       ; heat for KOMB cleaning
        KOMB
        CALIBRATE_MOVE_OVER_PROBE
        M109 S200       ; heat for XY calibration
        TOOL_CALIBRATE_TOOL_OFFSET
        M104 S0
    {% endfor %}
    # If/when you add tools 3+:
    # {% for tool in [1, 2, 3] %}

[gcode_macro CALIBRATE_NOZZLE_PROBE_OFFSET]
description: "Calibrate Z offset between nozzle and bed probe for the active tool"
gcode:
    {% set probe = printer.tool_probe_endstop.active_tool_probe %}
    CALIBRATE_MOVE_OVER_PROBE
    M109 S171           ; heat enough for consistent nozzle shape
    KOMB                ; clean the nozzle first
    CALIBRATE_MOVE_OVER_PROBE
    TOOL_LOCATE_SENSOR
    TOOL_CALIBRATE_PROBE_OFFSET PROBE="{probe}"
    M104 S0
