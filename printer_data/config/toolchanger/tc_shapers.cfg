# ============================================================
# tc_shapers.cfg — Toolchanger per-tool/per-axis input shapers
# Stays close to Contomo tc_shapers.cfg style
# ============================================================

# NOTE: input_shaper section is normally [input_shaper] (lowercase)
# You likely already have one in printer.cfg; if so, do NOT duplicate it.
# If you don't have one, add this (else ignore):

[input_shaper]
shaper_freq_x: 0
shaper_type_x: mzv
shaper_freq_y: 0
shaper_type_y: mzv
damping_ratio_x: 0.10
damping_ratio_y: 0.10


# ------------------------------------------------------------
# Wrapper: make SHAPER_CALIBRATE auto-pick the tool's accel chip
# ------------------------------------------------------------
[gcode_macro SHAPER_CALIBRATE]
rename_existing: _SHAPER_CALIBRATE
gcode:
  {% set tc = printer.toolchanger %}
  {% set tn = tc.tool_number|int %}
  {% set name = tc.tool_names[tn] %}
  {% set tool = printer[name] %}

  # Prefer per-tool param: params_accelerometer
  # Fallback: "adxl345 t0" naming pattern like in the example
  {% set accel = (tool.get('params_accelerometer', 'adxl345 ' ~ name|replace('tool ', '')))|string %}

  {% if 'CHIPS' not in params and accel|lower in printer.configfile.settings %}
    {% set _ = params.update({'CHIPS': accel}) %}
  {% endif %}

  _SHAPER_CALIBRATE {params|xmlattr}


# ------------------------------------------------------------
# Save pending shaper values into Save Variables (SVF)
# ------------------------------------------------------------
[gcode_macro _TC_SHAPER_CALIBRATE_SAVE_TO_SVF]
description: Save pending input_shaper values into SVF for a tool number
variable_defaults: {'type': "MZV", 'freq': 0.0, 'damp': 0.2}
gcode:
  {% set pend = printer.configfile.save_config_pending_items.input_shaper or {} %}
  {% if pend == {} %}
    RESPOND TYPE=error MSG="No pending input_shaper data found (nothing to save)."
    RETURN
  {% endif %}

  {% set tc = printer.toolchanger %}
  {% set tn = params.T|default(tc.tool_number)|int %}
  {% if tn not in tc.tool_numbers %}
    RESPOND TYPE=error MSG="_TC_SHAPER_CALIBRATE_SAVE_TO_SVF: Invalid tool T={tn}"
    RETURN
  {% endif %}

  {% set defaults = printer["gcode_macro _TC_SHAPER_CALIBRATE_SAVE_TO_SVF"].defaults %}

  {% set svf_key = 'shapers_t' ~ tn|string %}
  {% set svf     = printer.save_variables.variables or {} %}
  {% set merged  = svf.get(svf_key, {'x': {}, 'y': {}}) %}

  {% for ax in ['x','y'] %}
    {% set cur  = merged.get(ax, {}) %}

    {% set tkey = 'shaper_type_' ~ ax %}
    {% set tval = (pend.get(tkey, cur.get('type', defaults['type'])) | string).upper() %}
    {% set is_sm = ('SMOOTH' in tval) %}

    {% set fkey = ('smoother_freq_' if is_sm else 'shaper_freq_') ~ ax %}
    {% set fval = pend.get(fkey, cur.get('freq', defaults['freq'])) %}

    {% set dkey = 'damping_ratio_' ~ ax %}
    {% set dval = (pend.get(dkey, cur.get('damp', defaults['damp'])) if not is_sm else none) %}

    {% set _ = cur.update({'type': tval, 'freq': (fval|float)}) %}
    {% if (not is_sm) and (dval is not none) %}
      {% set _ = cur.update({'damp': (dval|float)}) %}
    {% endif %}
    {% set _ = merged.update({ax: cur}) %}
  {% endfor %}

  SAVE_VARIABLE VARIABLE={svf_key} VALUE="{merged}"
  { action_respond_info("Saved shapers to SVF key '" ~ svf_key ~ "': " ~ merged|tojson) }




# ------------------------------------------------------------
# Load shapers for a tool (SVF preferred, tool params fallback)
# ------------------------------------------------------------
[gcode_macro TC_LOAD_SHAPERS]
description: "Load input_shaper from SVF (preferred) or tool params"
gcode:
  {% set tc = printer.toolchanger %}
  {% set tn = params.T|default(tc.tool_number)|int %}

  {% if tn not in tc.tool_numbers %}
    RESPOND TYPE=error MSG="TC_LOAD_SHAPERS: Invalid tool number T={tn}"
    RETURN
  {% endif %}

  {% set name    = tc.tool_names[tn] %}
  {% set tool    = printer[name] %}
  {% set svf     = printer.save_variables.variables or {} %}

  # New canonical key
  {% set key_new = 'shapers_t' ~ tn|string %}
  # Back-compat key (your old name-based pattern)
  {% set key_old = 'shapers_' ~ name|replace('tool ', '')|lower %}

  {% set svfs = svf.get(key_new, {}) %}
  {% if svfs == {} %}
    {% set svfs = svf.get(key_old, {}) %}
  {% endif %}

  {% set cmd = [] %}
  {% for ax in ['x','y'] %}
    {% set s    = svfs.get(ax, {}) %}

    {% set type = s.get('type', tool.get('params_input_shaper_type_' ~ ax, ''))|string|upper %}
    {% set fval = s.get('freq', tool.get('params_input_shaper_freq_' ~ ax, None)) %}
    {% set dval = s.get('damp', tool.get('params_input_shaper_damping_ratio_' ~ ax, None)) %}

    {% set freq_key = ('SMOOTHER' if 'SMOOTH' in type else 'SHAPER') ~ '_FREQ_' ~ ax|upper %}

    {% if type %}{% set _ = cmd.append('SHAPER_TYPE_' ~ ax|upper ~ '=' ~ type) %}{% endif %}
    {% if fval is not none %}{% set _ = cmd.append(freq_key ~ '=' ~ fval) %}{% endif %}
    {% if (not 'SMOOTH' in type) and (dval is not none) %}{% set _ = cmd.append('DAMPING_RATIO_' ~ ax|upper ~ '=' ~ dval) %}{% endif %}
  {% endfor %}

  {% if cmd|length == 0 %}
    RESPOND TYPE=error MSG="TC_LOAD_SHAPERS: No shaper data found for T{tn} (looked for {key_new} and {key_old})"
    RETURN
  {% endif %}

  SET_INPUT_SHAPER {cmd|join(' ')}
  { action_respond_info("Loaded shapers for T" ~ tn ~ ": " ~ cmd|join(' | ')) }



# ------------------------------------------------------------
# Calibrate shapers for one tool or many tools
# Usage:
#   TC_SHAPER_CALIBRATE           (defaults to current tool)
#   TC_SHAPER_CALIBRATE T=2
#   TC_SHAPER_CALIBRATE T=all
#   TC_SHAPER_CALIBRATE T=0,2
# ------------------------------------------------------------
[gcode_macro TC_SHAPER_CALIBRATE]
description: Runs shaper calibration [T=<0,1,2...> or <all>], default → all
variable_save_to_svf: True
variable_save_to_config: False
variable_show_images: True
gcode:
  {% set P      = printer %}
  {% set tc     = P.toolchanger %}
  {% set tns    = tc.tool_numbers %}
  {% set cur    = tc.tool_number|int %}
  {% set req = (params.T|string|lower) if ('T' in params) else 'all' %}
  {% set queue  = [] %}

  # Build tool queue (keep current tool first if included)
  {% if req == 'all' %}
    {% for tn in tns %}
      {% set _ = queue.append(tn) %}
    {% endfor %}
  {% else %}
    {% for raw in req.split(',')|map('trim') %}
      {% set tn = raw|int(-1) %}
      {% if tn in tns and tn not in queue %}
        {% set _ = queue.insert(0, tn) if tn == cur else queue.append(tn) %}
      {% elif raw and tn not in tns %}
        { action_respond_info("TC_SHAPER_CALIBRATE: tool '" ~ raw ~ "' invalid, skipping.") }
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if queue|length == 0 %}
    RESPOND TYPE=error MSG="TC_SHAPER_CALIBRATE: No valid tools to process."
    RETURN
  {% endif %}
  {% if tc.status != 'ready' %}
    RESPOND TYPE=error MSG="TC_SHAPER_CALIBRATE: toolchanger status '{tc.status}' not ready."
    RETURN
  {% endif %}

  # Home if needed
  {% if P.toolhead.homed_axes|lower != 'xyz' %}
    { action_respond_info("TC_SHAPER_CALIBRATE: Homing first") }
    G28
  {% endif %}

  # Run each tool
  {% for tn in queue %}
    {% set name  = tc.tool_names[tn] %}
    {% set accel = (P[name].get('params_accelerometer', 'adxl345 ' ~ name|replace('tool ', '')))|string %}

    {% if accel|lower not in P.configfile.settings %}
      RESPOND TYPE=error MSG="TC_SHAPER_CALIBRATE: missing accelerometer config section [{accel}] for {name|replace('tool ', '')}"
      CONTINUE
    {% endif %}

    { action_respond_info("TC_SHAPER_CALIBRATE: Calibrating " ~ name|replace('tool ', '') ~ " (accel: " ~ accel ~ ")") }

    {% if tn != cur %}
      T{tn}
    {% endif %}
    
    SHAPER_CALIBRATE CHIPS="{accel}"

    {% if ('gcode_macro SHOW_LATEST_SHAPER_PLOT' in P.configfile.settings) and show_images %}
      { ("SHOW_LATEST_SHAPER_PLOT PREFIX=plot_" ~ (name|replace('tool ', '')|lower)) }
    {% endif %}

    {% if save_to_svf %}
      _TC_SHAPER_CALIBRATE_SAVE_TO_SVF T={tn}
    {% endif %}

    {% if save_to_config %}
      # Optional: keep your original _TC_SHAPER_CALIBRATE_SAVE_PARAMS macro if you want this
      { "_TC_SHAPER_CALIBRATE_SAVE_PARAMS NAME=\"" ~ (name|replace('tool ', '')) ~ "\"" if 'gcode_macro _TC_SHAPER_CALIBRATE_SAVE_PARAMS' in P.configfile.settings else '' }
    {% endif %}
  {% endfor %}

[gcode_macro SAVE_CONFIG]
rename_existing: _SAVE_CONFIG_REAL
gcode:
  {% if printer["gcode_macro TC_SHAPER_CALIBRATE"] is defined
        and printer.toolchanger.status == "changing" %}
    RESPOND TYPE=error MSG="SAVE_CONFIG is disabled for input shaper calibration. Use TC_SHAPER_CALIBRATE (SVF only)."
    RESPOND TYPE=warning MSG="Per-tool shapers are stored via SAVE_VARIABLE and loaded with TC_LOAD_SHAPERS."
    RETURN
  {% endif %}
  _SAVE_CONFIG_REAL

[gcode_macro TC_SHOW_APPLIED]
description: "Print currently-applied tool offsets, tool_probe z_offset, and shaper settings (best-effort)"
gcode:
  {% set tc = printer.toolchanger %}
  {% set tn = params.T|default(tc.tool_number)|int %}

  # ---- tool offsets (runtime on tool object) ----
  {% set tool_name = tc.tool_names[tn] if tn in tc.tool_numbers else None %}
  {% set tool_obj  = printer.printer.lookup_object(tool_name, None) if tool_name else None %}

  {% if tool_obj %}
    { action_respond_info(
      "APPLIED tool T" ~ tn ~
      " gcode_offsets: X=" ~ (tool_obj.gcode_x_offset|float|round(3)) ~
      " Y=" ~ (tool_obj.gcode_y_offset|float|round(3)) ~
      " Z=" ~ (tool_obj.gcode_z_offset|float|round(3))
    ) }
  {% else %}
    { action_respond_info("APPLIED tool T" ~ tn ~ ": could not lookup tool object (" ~ (tool_name|string) ~ ")") }
  {% endif %}

  # ---- tool_probe z_offset (runtime on tool_probe object) ----
  {% set sec = "tool_probe T" ~ tn %}
  {% set tp  = printer.printer.lookup_object(sec, None) %}
  {% if tp %}
    { action_respond_info("APPLIED tool_probe T" ~ tn ~ " z_offset=" ~ (tp.z_offset|float|round(4))) }
  {% else %}
    { action_respond_info("APPLIED tool_probe T" ~ tn ~ ": object '" ~ sec ~ "' not found") }
  {% endif %}

  # ---- input shaper (best effort) ----
  {% if 'input_shaper' in printer %}
    {% set ish = printer['input_shaper'] %}
    { action_respond_info(
      "APPLIED shaper: X=" ~ (ish.shaper_type_x|string) ~ "@" ~ (ish.shaper_freq_x|float|round(1)) ~
      " damp=" ~ (ish.damping_ratio_x|float|round(3)) ~
      " | Y=" ~ (ish.shaper_type_y|string) ~ "@" ~ (ish.shaper_freq_y|float|round(1)) ~
      " damp=" ~ (ish.damping_ratio_y|float|round(3))
    ) }
  {% else %}
    { action_respond_info("APPLIED shaper: cannot read (no 'input_shaper' object on this build). Use TC_LOAD_SHAPERS output as confirmation.") }
  {% endif %}
