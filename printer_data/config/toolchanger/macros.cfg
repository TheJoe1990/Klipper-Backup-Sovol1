# ============================================================
# FORGET_TOOL
# ============================================================
[gcode_macro FORGET_TOOL]
description: "Plain English: Emergency recovery. Forces shuttle probe (T=-100), clears offsets, and unselects tool so future picks are safe."
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Goal:
    # - When tool state is wrong (tool fell off / toolchanger confused),
    #   we want the printer to behave like:
    #     'NO TOOL IS MOUNTED'
    #   and we want probing/homing to use the shuttle probe (T=-100).
    #
    # What we do:
    # 1) Stop motion queue (M400) so state changes apply cleanly.
    # 2) Clear all gcode offsets (X/Y/Z) so no tool offsets remain.
    # 3) Force the ACTIVE tool probe routing to the shuttle probe (T=-100)
    #    so probe operations have a valid probe selected.
    # 4) Attempt to unselect the tool in the toolchanger (best effort).
    #
    # Notes:
    # - SET_ACTIVE_TOOL_PROBE selects which probe is used for probing.
    #   It does not itself change 'which tool is mounted'.
    # - The unselect step is what prevents "it still thinks T0 is mounted".
    # =====================================================================

    M400

    # Clear any offsets that might have come from a previously active tool
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # Force shuttle probe routing so probe commands have a valid active probe
    SET_ACTIVE_TOOL_PROBE T=-100

    # Try to make toolchanger state match "no tool mounted" (best effort)
    {% if "gcode_macro UNSELECT_TOOL" in printer %}
        UNSELECT_TOOL
    {% elif "gcode_macro TOOL_UNSELECT" in printer %}
        TOOL_UNSELECT
    {% elif "gcode_macro CLEAR_TOOL" in printer %}
        CLEAR_TOOL
    {% endif %}

    # Optional: if your toolchanger has a "set tool = none" variable macro,
    # call it here. (Leaving out because I won't invent names.)

    # Print a compact state dump
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: tool_probe_endstop.active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="FORGET_TOOL: tool_probe_endstop.active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('None')}"
    {% endif %}
    {% if 'toolchanger' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: toolchanger.tool_number={printer.toolchanger.tool_number|default('undef')}"
    {% endif %}

    RESPOND TYPE=echo MSG="FORGET_TOOL: Forced shuttle probe T=-100 + cleared offsets + attempted tool unselect."



[gcode_macro UI_UNSELECT_TOOL]
description: "UI button: call UNSELECT_TOOL
gcode:
    UNSELECT_TOOL
    RESPOND TYPE=echo MSG="UI_UNSELECT_TOOL: done"


[gcode_macro _TAP_PROBE_ACTIVATE]
description: Ensure safe temp for bed probing
gcode:
    {% set max_temp = 150 %}
    {% set actual_temp = printer[params.HEATER].temperature %}
    {% set target_temp = printer[params.HEATER].target %}
    {% if target_temp > max_temp %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (target_temp, max_temp)) }
        SET_HEATER_TEMPERATURE HEATER={params.HEATER} TARGET={ max_temp|int - 5 }
    {% endif %}
    # Temperature target is already low enough, but nozzle may still be too hot.
    {% if actual_temp > max_temp  + 2 %}
        { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (actual_temp, max_temp)) }
        TEMPERATURE_WAIT SENSOR={params.HEATER} MAXIMUM={ max_temp }
    {% endif %}

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    # 1) Set the temperature for the requested tool using M104
    M104 {rawparams}
    # 2) Look up the tool object and wait on its extruder temp
    {% if params.S is defined %}
      {% set tool = printer['tool T' ~ (params.T|string)] %}
      TEMPERATURE_WAIT SENSOR={tool.extruder} \
        MINIMUM={(params.S|int)-2} MAXIMUM={(params.S|int)+2}
    {% endif %}
  {% else %}
    # No T param -> fall back to the original M109
    M109.1 {rawparams}
  {% endif %}

[gcode_macro TOOL0]
gcode: T0

[gcode_macro TOOL1]
gcode: T1

[gcode_macro TOOL3]
gcode: T3

[gcode_macro TOOL4]
gcode: T4
