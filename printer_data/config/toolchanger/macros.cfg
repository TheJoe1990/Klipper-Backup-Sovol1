# ============================================================
# FORGET_TOOL
# ============================================================
[gcode_macro FORGET_TOOL]
description: "Plain English: Hard reset toolchanger state to 'no tool mounted' (post-boot equivalent)."
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Purpose:
    # - Simulate the toolchanger state immediately after firmware boot.
    # - Used when a tool fell off or internal tool state is incorrect.
    #
    # What this macro guarantees AFTER it runs:
    # - Toolchanger assumes NO tool is mounted
    # - Shuttle probe (-100) is active for probing
    # - All tool offsets are cleared
    # - Future homing + DETECT + tool pickup are safe
    #
    # What this macro intentionally does NOT do:
    # - It does NOT attempt detection
    # - It does NOT move the machine
    # - It does NOT guess which tool might be present
    #
    # After running this macro, you MUST:
    # - Run G28 (or explicit DETECT + pickup)
    # =====================================================================

    M400

    # 1) Clear all gcode offsets so no tool offsets remain
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # 2) Force shuttle probe to be the active probe
    #    (so probing/homing works with no tool)
    SET_ACTIVE_TOOL_PROBE T=-100

    # 3) Force toolchanger into "no tool selected" state
    #    This is the CRITICAL step.
    {% if 'toolchanger' in printer %}
        SET_TOOL_TEMPERATURE TOOL=all TARGET=0
        SET_TOOL_TEMPERATURE TOOL=all STANDBY=0

        # Clear toolchanger internal state
        SET_GCODE_VARIABLE MACRO=toolchanger VARIABLE=tool_number VALUE=-1
        SET_GCODE_VARIABLE MACRO=toolchanger VARIABLE=active_tool VALUE=None
    {% endif %}

    # 4) Best-effort compatibility with existing unselect macros
    {% if "gcode_macro UNSELECT_TOOL" in printer %}
        UNSELECT_TOOL
    {% endif %}

    RESPOND TYPE=echo MSG="FORGET_TOOL: Toolchanger reset to 'no tool mounted' state."



[gcode_macro UI_UNSELECT_TOOL]
description: "UI button: call UNSELECT_TOOL
gcode:
    UNSELECT_TOOL
    RESPOND TYPE=echo MSG="UI_UNSELECT_TOOL: done"


[gcode_macro _TAP_PROBE_ACTIVATE]
description: Ensure safe temp for bed probing
gcode:
    {% set max_temp = 150 %}
    {% set actual_temp = printer[params.HEATER].temperature %}
    {% set target_temp = printer[params.HEATER].target %}
    {% if target_temp > max_temp %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (target_temp, max_temp)) }
        SET_HEATER_TEMPERATURE HEATER={params.HEATER} TARGET={ max_temp|int - 5 }
    {% endif %}
    # Temperature target is already low enough, but nozzle may still be too hot.
    {% if actual_temp > max_temp  + 2 %}
        { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (actual_temp, max_temp)) }
        TEMPERATURE_WAIT SENSOR={params.HEATER} MAXIMUM={ max_temp }
    {% endif %}

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    # 1) Set the temperature for the requested tool using M104
    M104 {rawparams}
    # 2) Look up the tool object and wait on its extruder temp
    {% if params.S is defined %}
      {% set tool = printer['tool T' ~ (params.T|string)] %}
      TEMPERATURE_WAIT SENSOR={tool.extruder} \
        MINIMUM={(params.S|int)-2} MAXIMUM={(params.S|int)+2}
    {% endif %}
  {% else %}
    # No T param -> fall back to the original M109
    M109.1 {rawparams}
  {% endif %}

[gcode_macro TOOL0]
gcode: T0

[gcode_macro TOOL1]
gcode: T1

[gcode_macro TOOL3]
gcode: T3

[gcode_macro TOOL4]
gcode: T4
