[gcode_macro FORGET_TOOL]
description: "Plain English: Emergency recovery. Clear active tool state + active tool probe + offsets. Use when a tool fell off or state is wrong."
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Use this when REALITY != SOFTWARE (ex: tool fell off, or you manually
    # moved a tool, and the printer still 'thinks' a tool is mounted).
    #
    # What we must clear:
    #  1) Active tool-probe routing (otherwise probe queries can error or point
    #     at the wrong MCU/probe)
    #  2) G-code offsets (otherwise coordinates remain biased for the old tool)
    #  3) Toolchanger's "active tool" selection (so future pickups don't assume
    #     we still have T0 and crash into a docked tool)
    #
    # After clearing, we immediately run DETECT_ACTIVE_TOOL_PROBE to force the
    # tool_probe_endstop state to refresh NOW (not later).
    # =====================================================================

    M400

    # Best-effort: stop crash detection if itâ€™s running
    {% if "gcode_macro STOP_TOOL_PROBE_CRASH_DETECTION" in printer %}
        STOP_TOOL_PROBE_CRASH_DETECTION
    {% endif %}

    # Debug: show what toolchanger thinks BEFORE we clear
    {% if 'toolchanger' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: before toolchanger.tool_number={printer.toolchanger.tool_number|default('undef')}"
    {% endif %}
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: before active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="FORGET_TOOL: before active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('None')}"
    {% endif %}

    # 1) Clear any active probe selection
    SET_ACTIVE_TOOL_PROBE T=-1

    # 2) Clear coordinate offsets that imply a specific tool is active
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # 3) Clear toolchanger active tool (best available method in your setup)
    {% if "gcode_macro UNSELECT_TOOL" in printer %}
        UNSELECT_TOOL
    {% elif "gcode_macro UNSELECT_TOOLHEAD" in printer %}
        UNSELECT_TOOLHEAD
    {% else %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: No UNSELECT_TOOL* macro found; toolchanger may still think a tool is active."
    {% endif %}

    M400
    G4 P100

    # Force-refresh probe/tool detection state immediately
    {% if 'tool_probe_endstop' in printer %}
        DETECT_ACTIVE_TOOL_PROBE
    {% endif %}

    # Debug: show what we ended up with
    {% if 'toolchanger' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: after toolchanger.tool_number={printer.toolchanger.tool_number|default('undef')}"
    {% endif %}
    {% if 'tool_probe_endstop' in printer %}
        RESPOND TYPE=echo MSG="FORGET_TOOL: after active_tool_number={printer.tool_probe_endstop.active_tool_number|default('undef')}"
        RESPOND TYPE=echo MSG="FORGET_TOOL: after active_tool_probe={printer.tool_probe_endstop.active_tool_probe|default('None')}"
        RESPOND TYPE=echo MSG="FORGET_TOOL: last_query={printer.tool_probe_endstop.last_tools_query|default('undef')}"
    {% endif %}

    RESPOND TYPE=echo MSG="FORGET_TOOL: Cleared tool/probe/offset state. Safe to re-home and then pick up the correct tool."



[gcode_macro UI_UNSELECT_TOOL]
description: "UI button: call UNSELECT_TOOL
gcode:
    UNSELECT_TOOL
    RESPOND TYPE=echo MSG="UI_UNSELECT_TOOL: done"


[gcode_macro _TAP_PROBE_ACTIVATE]
description: Ensure safe temp for bed probing
gcode:
    {% set max_temp = 150 %}
    {% set actual_temp = printer[params.HEATER].temperature %}
    {% set target_temp = printer[params.HEATER].target %}
    {% if target_temp > max_temp %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (target_temp, max_temp)) }
        SET_HEATER_TEMPERATURE HEATER={params.HEATER} TARGET={ max_temp|int - 5 }
    {% endif %}
    # Temperature target is already low enough, but nozzle may still be too hot.
    {% if actual_temp > max_temp  + 2 %}
        { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (actual_temp, max_temp)) }
        TEMPERATURE_WAIT SENSOR={params.HEATER} MAXIMUM={ max_temp }
    {% endif %}

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    # 1) Set the temperature for the requested tool using M104
    M104 {rawparams}
    # 2) Look up the tool object and wait on its extruder temp
    {% if params.S is defined %}
      {% set tool = printer['tool T' ~ (params.T|string)] %}
      TEMPERATURE_WAIT SENSOR={tool.extruder} \
        MINIMUM={(params.S|int)-2} MAXIMUM={(params.S|int)+2}
    {% endif %}
  {% else %}
    # No T param -> fall back to the original M109
    M109.1 {rawparams}
  {% endif %}

[gcode_macro TOOL0]
gcode: T0

[gcode_macro TOOL1]
gcode: T1

[gcode_macro TOOL3]
gcode: T3

[gcode_macro TOOL4]
gcode: T4
