# ============================================================
# FORGET_TOOL
# ============================================================
[gcode_macro FORGET_TOOL]
description: "Plain English: Recovery helper. Force 'no tool' behavior as best we can using supported commands."
gcode:
    # =====================================================================
    # PLAIN ENGLISH EXPLAINER
    #
    # Use this when the physical tool state and the internal tool state disagree
    # (example: T0 fell off, but the printer still thinks T0 is mounted).
    #
    # What this macro DOES:
    # - Clears gcode offsets (so no tool offsets remain applied)
    # - Forces the shuttle probe (T=-100) as the active tool probe for safe probing
    # - Calls UNSELECT_TOOL (this MUST be the place that truly clears toolchanger state)
    # - Optionally runs DETECT_ACTIVE_TOOL_PROBE to refresh probe-side state
    #
    # What this macro CANNOT do by itself:
    # - It cannot directly rewrite the toolchanger python object's internal state.
    #   If UNSELECT_TOOL does not truly clear the active tool, you will still need
    #   to fix UNSELECT_TOOL (or use FIRMWARE_RESTART).
    # =====================================================================

    M400

    # Clear tool offsets
    SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0

    # Force shuttle tool-probe to be active for safe probing/homing
    SET_ACTIVE_TOOL_PROBE T=-100
    G4 P100

    # This is the critical hook: it must actually clear the toolchanger's active tool
    UNSELECT_TOOL

    # Refresh probe-side detection info (safe, no motion)
    {% if "DETECT_ACTIVE_TOOL_PROBE" in printer.gcode.commands %}
        DETECT_ACTIVE_TOOL_PROBE
    {% endif %}

    RESPOND TYPE=echo MSG="FORGET_TOOL: offsets cleared + shuttle probe active + UNSELECT_TOOL invoked."



[gcode_macro UI_UNSELECT_TOOL]
description: "UI button: call UNSELECT_TOOL
gcode:
    UNSELECT_TOOL
    RESPOND TYPE=echo MSG="UI_UNSELECT_TOOL: done"


[gcode_macro _TAP_PROBE_ACTIVATE]
description: Ensure safe temp for bed probing
gcode:
    {% set max_temp = 150 %}
    {% set actual_temp = printer[params.HEATER].temperature %}
    {% set target_temp = printer[params.HEATER].target %}
    {% if target_temp > max_temp %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (target_temp, max_temp)) }
        SET_HEATER_TEMPERATURE HEATER={params.HEATER} TARGET={ max_temp|int - 5 }
    {% endif %}
    # Temperature target is already low enough, but nozzle may still be too hot.
    {% if actual_temp > max_temp  + 2 %}
        { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (actual_temp, max_temp)) }
        TEMPERATURE_WAIT SENSOR={params.HEATER} MAXIMUM={ max_temp }
    {% endif %}

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>]
  Set tool temperature and wait.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    # 1) Set the temperature for the requested tool using M104
    M104 {rawparams}
    # 2) Look up the tool object and wait on its extruder temp
    {% if params.S is defined %}
      {% set tool = printer['tool T' ~ (params.T|string)] %}
      TEMPERATURE_WAIT SENSOR={tool.extruder} \
        MINIMUM={(params.S|int)-2} MAXIMUM={(params.S|int)+2}
    {% endif %}
  {% else %}
    # No T param -> fall back to the original M109
    M109.1 {rawparams}
  {% endif %}

[gcode_macro TOOL0]
gcode: T0

[gcode_macro TOOL1]
gcode: T1

[gcode_macro TOOL3]
gcode: T3

[gcode_macro TOOL4]
gcode: T4
