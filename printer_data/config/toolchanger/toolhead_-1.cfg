# ---------------------------------------------------------------------
# Toolless homing shuttle probe (negative tool probe)
# ---------------------------------------------------------------------
[tool_probe T-1]
# Shuttle microswitch wired here – adjust pin if needed
pin: ^!PF1
tool: -1
z_offset: 6.7              # <-- your calibrated shuttle Z offset
speed: 10.0
samples: 4
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.01
samples_tolerance_retries: 3


# ---------------------------------------------------------------------
# Adjust Z after homing (works for both shuttle and normal tools)
# ---------------------------------------------------------------------
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -1
gcode:
    G90 ; absolute mode
    G0 Z10 F1000
    {% if (printer.probe.active_tool_number | int) == shuttle_tool_number %}
      # Homed with shuttle probe (T-1)
      {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
      SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset|float}
    {% else %}
      # Homed with normal tool probe
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float + probe_z_offset|float}
      {% endif %}
    {% endif %}


# ---------------------------------------------------------------------
# _HOME macro – decides between toolless and normal homing
# ---------------------------------------------------------------------
[gcode_macro TOOLLESS_HOME]
gcode:
    # Home Y first so shuttle can reach switch
    {% set axes = params|default("") %}
    {% set all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}

    # Optional: use the shuttle probe tool
    SET_ACTIVE_TOOL_PROBE T=-1

    {% if all or 'Y' in axes %}
        G28 Y
        G90
        G0 Y175 F12000
    {% endif %}

    {% if all or 'X' in axes %}
        _SENSORLESS_HOME_X
        G90
        G0 X175 F12000
    {% endif %}

    {% if all or 'Z' in axes %}
        G90
        G0 X281.6 Y326.1 F12000
        G28 Z
        G0 Z10 F12000
        G0 X175 Y175 Z10 F12000
        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}
