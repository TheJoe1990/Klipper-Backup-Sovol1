# ---------------------------------------------------------------------
# Toolless homing shuttle probe (negative tool probe)
# ---------------------------------------------------------------------
[tool_probe T-1]
# Shuttle microswitch wired here – adjust pin if needed
pin: ^!PF1
tool: -1
z_offset: 6.7              # <-- your calibrated shuttle Z offset
speed: 10.0
samples: 4
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.01
samples_tolerance_retries: 3


# ---------------------------------------------------------------------
# Adjust Z after homing (works for both shuttle and normal tools)
# ---------------------------------------------------------------------
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -1
gcode:
    G90 ; absolute mode
    G0 Z10 F1000
    {% if (printer.probe.active_tool_number | int) == shuttle_tool_number %}
      # Homed with shuttle probe (T-1)
      {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
      SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset|float}
    {% else %}
      # Homed with normal tool probe
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float + probe_z_offset|float}
      {% endif %}
    {% endif %}


# ---------------------------------------------------------------------
# _HOME macro – decides between toolless and normal homing
# ---------------------------------------------------------------------
[gcode_macro _HOME]
variable_shuttle_endstop_x: 281.6   # <-- your shuttle switch X
variable_shuttle_endstop_y: 326.1   # <-- your shuttle switch Y
variable_shuttle_tool_number: -1
gcode:
  {% set axes = params.AXIS|default("") %}
  {% set home_all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}

  {% if (printer.probe.active_tool_number | int) == -1 %}
    # ----------------------------
    # TOOL-LESS HOMING (no tool loaded)
    # ----------------------------
    SET_ACTIVE_TOOL_PROBE T={shuttle_tool_number}
    RESPOND TYPE=echo MSG='No active tool detected ({printer.probe.active_tool_number}), doing toolless homing'

    # Home Y then X so the shuttle can reach the rear switch
    {% if home_all or 'Y' in axes %}
      G28 Y
      G90
      G0 Y175 F12000
    {% endif %}

    {% if home_all or 'X' in axes %}
      _SENSORLESS_HOME_X
      G90
      G0 X175 F12000
    {% endif %}

    {% if home_all or 'Z' in axes %}
      G90
      G0 X{shuttle_endstop_x} Y{shuttle_endstop_y} F12000
      G28 Z
      G0 Z10 F12000
      G0 X175 Y175 Z10 F12000
      _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}

  {% else %}
    # ----------------------------
    # NORMAL HOMING (tool loaded)
    # – this is your existing homing logic, adapted to use "axes"
    # ----------------------------
    RESPOND TYPE=echo MSG='Tool {printer.probe.active_tool_number} detected, homing as normal.'
    _INITIALIZE_FROM_DETECTED_TOOL
    STOP_TOOL_PROBE_CRASH_DETECTION

    {% if printer.probe.last_query  %}
      RESPOND TYPE=echo MSG='Z Probe triggered, cannot home.'
    {% else %}
      SET_GCODE_OFFSET X=0.0 Y=0.0 Z=0.0
      {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

      {% if home_all %}
        G90 ; absolute mode
        G28 Z
        G0 Z10 F1000
      {% endif %}

      {% if home_all or 'Y' in axes or 'X' in axes %}
        G28 Y
      {% endif %}

      {% if home_all or 'X' in axes %}
        G90 ; absolute mode
        G0 Y{ max_y - 175 } F5000
        _SENSORLESS_HOME_X
        G91 ; relative mode
        G0 X-10 F5000
        G0 X-165 F5000
        G28 Y
      {% endif %}

      {% if home_all or 'Z' in axes %}
        {% set random_x = (range(-50, 50) | random) / 10 %}
        {% set random_y = (range(-50, 50) | random) / 10 %}

        G90 ; absolute mode
        G0 X{175.0+random_x} Y{175.0+random_y} F12000
        G28 Z
        _ADJUST_Z_HOME_FOR_TOOL_OFFSET
      {% endif %}
    {% endif %}
  {% endif %}

  _APPLY_ACTIVE_TOOL_GCODE_OFFSETS
  M400
  SET_TMC_FIELD STEPPER=stepper_x FIELD=TPWMTHRS VALUE=0
  SET_TMC_FIELD STEPPER=stepper_y FIELD=TPWMTHRS VALUE=0
  SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadCycle VALUE=1
  SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadCycle VALUE=1
