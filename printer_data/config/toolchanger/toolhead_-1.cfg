# ---------------------------------------------------------------------
# Toolless homing shuttle probe (negative tool probe)
# ---------------------------------------------------------------------
[tool_probe T-1]
pin: ^PE12
tool: -1
z_offset: -10.7              # <-- your calibrated shuttle Z offset
speed: 10.0
samples: 4
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.01
samples_tolerance_retries: 3


# ---------------------------------------------------------------------
# Adjust Z after homing (works for both shuttle and normal tools)
# ---------------------------------------------------------------------
[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -1
gcode:
    G90 ; absolute mode
    G0 Z10 F1000
    {% if (printer.probe.active_tool_number | int) == shuttle_tool_number %}
      # Homed with shuttle probe (T-1)
      {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
      SET_KINEMATIC_POSITION Z={20.0 + probe_z_offset|float}
    {% else %}
      # Homed with normal tool probe
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float + probe_z_offset|float}
      {% endif %}
    {% endif %}



[gcode_button shuttle_dome_test]
pin: ^PE12
press_gcode:
  RESPOND TYPE=echo MSG="shuttle dome: PRESSED (PE12)"
release_gcode:
  RESPOND TYPE=echo MSG="shuttle dome: RELEASED (PE12)"


[gcode_macro _SELECT_SHUTTLE_PROBE_OR_PAUSE]
description: "Ensure shuttle probe (T=-1) is active before any shuttle Z homing"
gcode:
    RESPOND TYPE=echo MSG="_SELECT_SHUTTLE_PROBE_OR_PAUSE: selecting shuttle probe (T=-1)"
    SET_ACTIVE_TOOL_PROBE T=-1
    G4 P150

    {% if 'tool_probe_endstop' in printer %}
        {% set atn = printer.tool_probe_endstop.active_tool_number | default(-99) | int %}
        {% set atp = printer.tool_probe_endstop.active_tool_probe | default('None') %}
        RESPOND TYPE=echo MSG="_SELECT_SHUTTLE_PROBE_OR_PAUSE: active_tool_number={atn} active_tool_probe={atp}"
        {% if atn != -1 %}
            RESPOND TYPE=error MSG="_SELECT_SHUTTLE_PROBE_OR_PAUSE: expected active_tool_number=-1 (shuttle) but got {atn}. Pausing."
            PAUSE
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="_SELECT_SHUTTLE_PROBE_OR_PAUSE: tool_probe_endstop missing; cannot verify shuttle probe selection. Pausing."
        PAUSE
    {% endif %}
