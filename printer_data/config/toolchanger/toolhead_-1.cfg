[tool_probe T-1]
pin: PE12
tool: -1
z_offset: -6.7
speed: 10.0
samples: 4
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.01 # 0.006
samples_tolerance_retries: 3

[gcode_macro _ADJUST_Z_HOME_FOR_TOOL_OFFSET]
variable_shuttle_tool_number: -1
gcode:
    G90 ; absolute mode
    G0 Z10 F1000
    {% if (printer.probe.active_tool_number | int) == shuttle_tool_number %}
      {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
      SET_KINEMATIC_POSITION Z={10.0 + probe_z_offset|float}
    {% else %}
      {% set tool = printer.toolchanger.tool %}
      {% if tool %}
         {% set tool_z_offset = printer[tool].gcode_z_offset %}
         {% set probe_z_offset = printer.tool_probe_endstop.active_tool_probe_z_offset %}
         SET_KINEMATIC_POSITION Z={10.0 + tool_z_offset|float + probe_z_offset|float}
      {% endif %}
    {% endif %}

# ---------------------------------------------------------------------
# _HOME macro wrapper for toolless vs normal homing
# ---------------------------------------------------------------------
[gcode_macro _HOME]
variable_shuttle_endstop_x: 80   # TODO: set to shuttle switch X
variable_shuttle_endstop_y: 347  # TODO: set to shuttle switch Y
variable_shuttle_tool_number: -1
gcode:
  {% set axes = params.AXIS|default("") %}
  {% set home_all = ('X' not in axes and 'Y' not in axes and 'Z' not in axes) %}

  {% if (printer.probe.active_tool_number | int) == -1 %}
    SET_ACTIVE_TOOL_PROBE T={shuttle_tool_number}
    RESPOND TYPE=echo MSG='No active tool detected ({printer.probe.active_tool_number}), doing toolless homing'

    # Y first so the shuttle can reach the switch
    {% if home_all or 'Y' in axes %}
      _SENSORLESS_HOME_Y
      G90
      G0 Y175 F12000
    {% endif %}

    {% if home_all or 'X' in axes %}
      _SENSORLESS_HOME_X
      G90
      G0 X175 F12000
    {% endif %}

    # Move shuttle to the switch and home Z using the shuttle probe
    {% if home_all or 'Z' in axes %}
      G90
      G0 X{shuttle_endstop_x} Y{shuttle_endstop_y} F12000
      G28 Z

      G0 Z10 F12000
      G0 X175 Y175 Z10 F12000
      _ADJUST_Z_HOME_FOR_TOOL_OFFSET
    {% endif %}

  {% else %}
    RESPOND TYPE=echo MSG='Tool {printer.probe.active_tool_number} detected, homing as normal.'
    INITIALIZE_TOOLCHANGER T={printer.probe.active_tool_number}

    # ----------------------------
    # TODO: we will splice your existing "normal" homing logic here
    #       once you show me your current [homing_override] / homing macros.
    # ----------------------------

  {% endif %}