[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_macro T0]
variable_tool: 0
variable_spool_id: None
variable_pressure_advance: None
gcode:
  {% if pressure_advance != None %}
    SET_PRESSURE_ADVANCE EXTRUDER={printer[printer.toolchanger.tool_names[tool]].extruder} ADVANCE={pressure_advance}
  {% endif %}
  SELECT_TOOL T={tool}

[gcode_macro T1]
variable_tool: 1
variable_spool_id: None
variable_pressure_advance: None
gcode:
  {% if pressure_advance != None %}
    SET_PRESSURE_ADVANCE EXTRUDER={printer[printer.toolchanger.tool_names[tool]].extruder} ADVANCE={pressure_advance}
  {% endif %}
  SELECT_TOOL T={tool}

[gcode_macro T2]
variable_tool: 2
variable_spool_id: None
variable_pressure_advance: None
gcode:
  {% if pressure_advance != None %}
    SET_PRESSURE_ADVANCE EXTRUDER={printer[printer.toolchanger.tool_names[tool]].extruder} ADVANCE={pressure_advance}
  {% endif %}
  SELECT_TOOL T={tool}

#[gcode_macro T3]
#variable_tool: 3
#variable_spool_id: None
#variable_pressure_advance: None
#gcode:
#  {% if pressure_advance != None %}
#    SET_PRESSURE_ADVANCE EXTRUDER={printer[printer.toolchanger.tool_names[tool]].extruder} ADVANCE={pressure_advance}
#  {% endif %}
#  SELECT_TOOL T={tool}
  
[gcode_macro SET_TOOL_MAPPING]
description: [T<number>] [TOOL<number>]
  Set tool mapping.
  T= T command number
  TOOL= Physical tool number
gcode:
  {% if params.T is defined and params.TOOL is defined %}
    SET_GCODE_VARIABLE MACRO=T{params.T} VARIABLE=tool VALUE={params.TOOL}
  {% else %}
    {action_raise_error("Specify T and TOOL parameters.")}
  {% endif %}

[gcode_macro RESET_TOOL_MAPPING]
description: Reset tool mapping.
gcode:
  {% for tn in range(printer.toolchanger.tool_names | length) %}
    SET_TOOL_MAPPING T={tn} TOOL={tn}
  {% endfor %}

[gcode_macro SET_TOOL_COLOR]
description: [T<number>] [COLOR<hexstring>]
  Set tool's filament color.
  TOOL= Physical tool number
  COLOR= RGB hex string
gcode:
  {% if params.TOOL is defined and params.COLOR is defined %} 
    {% set tool = params.TOOL|int %}
    {% set color = params.COLOR|string %}
    
    {% if printer.save_variables.variables.filament_colors is defined %}
        {% set filament_colors = printer.save_variables.variables.filament_colors %}        
        {% if tool >= 0 and tool < filament_colors|length %}
            {% set filament_colors = filament_colors[:tool] + [color] + filament_colors[tool+1:] %}
            SAVE_VARIABLE VARIABLE=filament_colors VALUE='{filament_colors | tojson}'
        {% else %}
            {action_raise_error("Tool number out of range.")}
        {% endif %}
    {% else %}
        {action_raise_error("Filament colors variable not found.")}
    {% endif %}
  {% else %}
    {action_raise_error("Specify TOOL and COLOR parameters.")}
  {% endif %}

[gcode_macro SET_TOOL_MATERIAL]
description: [T<number>] [MATERIAL<string>]
  Set tool's filament material.
  TOOL= Physical tool number
  MATERIAL= string, e.g. PLA, ABS, ...
gcode:
  {% if params.TOOL is defined and params.MATERIAL is defined %} 
    {% set tool = params.TOOL|int %}
    {% set material = params.MATERIAL|string %}
    
    {% if printer.save_variables.variables.filament_types is defined %}
        {% set filament_types = printer.save_variables.variables.filament_types %}        
        {% if tool >= 0 and tool < filament_types|length %}
            {% set filament_types = filament_types[:tool] + [material] + filament_types[tool+1:] %}
            SAVE_VARIABLE VARIABLE=filament_types VALUE='{filament_types | tojson}'
        {% else %}
            {action_raise_error("Tool number out of range.")}
        {% endif %}
    {% else %}
        {action_raise_error("Filament types variable not found.")}
    {% endif %}
  {% else %}
    {action_raise_error("Specify TOOL and MATERIAL parameters.")}
  {% endif %}

[gcode_macro SET_TOOL_PRESSURE_ADVANCE]
description: [TOOL<number>] [ADVANCE<number>]
  Set tool pressure advance.
  TOOL= Physical tool number
gcode:
  {% if params.T is defined and params.TOOL is defined %}
    SET_GCODE_VARIABLE MACRO=T{params.T} VARIABLE=tool VALUE={params.TOOL}
  {% else %}
    {action_raise_error("Specify T and TOOL parameters.")}
  {% endif %}
  
[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set target_tool = printer["gcode_macro T"~params.T].tool %}
    {% set newparameters = " T="~target_tool %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE {newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: [T<index>] [S<temperature>] [D<Deadband>]
  Set tool temperature and wait.
  T= Tool number [optional]. If this parameter is not provided, the current tool is used.
  S= Target temperature
  D= Dead-band, allows the temperature variance +/- the deadband
variable_default_deadband: 4.0
gcode:
    {% set s = params.S|float %}
    {% set deadband = default_deadband|float %}
    {% set tn = printer.tool_probe_endstop.active_tool_number|int %}
    {% if params.D is defined %}
        {% set deadband = params.D|float %}
    {% endif %}
    {% if params.T is defined %}
        {% set tn = printer["gcode_macro T"~params.T].tool %}
    {% endif %}
    {% set tool_name = printer.toolchanger.tool_names[tn]|default('') %}
    {% set extruder = printer[tool_name].extruder %}

    SET_HEATER_TEMPERATURE HEATER={extruder} TARGET={s}
    {% if s > 0 %}
        TEMPERATURE_WAIT SENSOR={extruder} MINIMUM={s-(deadband/2)} MAXIMUM={s+(deadband/2)}   ; Wait for hotend temp (within D degrees)
    {% endif %}





[gcode_macro UNLOAD_ONE_FILAMENT]
description: Wrapper for toolchanger UI - unload filament from specific tool (probe-based, QGL only if toolchange)
gcode:
    {% set tool = params.TOOL|default(0)|int %}
    {% set state = printer.print_stats.state %}
    {% set unload_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set preheat_temp = 125 %}

    M117 UNLOAD: start T{tool}

    # Block during print or pause
    {% if state in ["printing", "paused"] %}
        M117 UNLOAD: blocked ({state})
        {action_respond_info("UNLOAD_ONE_FILAMENT blocked during '%s'." % state)}
        RETURN
    {% endif %}

    # 1) Preheat requested tool to 125C (no wait)
    M117 UNLOAD: preheat T{tool} to {preheat_temp}C
    M104 T{tool} S{preheat_temp}

    # 2) Detect active tool via tool probe BEFORE any homing
    DETECT_ACTIVE_TOOL_PROBE
    {% if printer.probe.active_tool_number is defined %}
        {% set detected_tool = printer.probe.active_tool_number|int %}
    {% else %}
        {% set detected_tool = -1 %}
    {% endif %}
    {% set is_homed = "xyz" in printer.toolhead.homed_axes %}
    M117 UNLOAD: detected={detected_tool} homed={is_homed}

    # 3) If we already have the right tool AND we're homed: no G28, no QGL, no toolchange
    {% if detected_tool == tool and is_homed %}
        M117 UNLOAD: correct tool & homed, no G28/QGL/toolchange

    {% else %}
        # We either have the wrong tool, unknown tool, or not homed.

        {% if not is_homed %}
            M117 UNLOAD: machine not homed → G28
            G28
            {% set is_homed = True %}
        {% else %}
            M117 UNLOAD: homed, skipping extra G28
        {% endif %}

        # Re-detect tool after homing, then QGL+toolchange if needed
        DETECT_ACTIVE_TOOL_PROBE
        {% if printer.probe.active_tool_number is defined %}
            {% set detected_tool2 = printer.probe.active_tool_number|int %}
        {% else %}
            {% set detected_tool2 = -1 %}
        {% endif %}
        M117 UNLOAD: post-home detected={detected_tool2}

        {% if detected_tool2 != tool %}
            # Need a toolchange → ALWAYS QGL first
            M117 UNLOAD: QGL before toolchange
            QUAD_GANTRY_LEVEL

            M117 UNLOAD: SELECT_TOOL T{tool}
            SELECT_TOOL T={tool}
        {% else %}
            M117 UNLOAD: now on correct tool after homing; no toolchange
        {% endif %}
    {% endif %}

    # 4) Heat to unload temp (no wait)
    M117 UNLOAD: heat T{tool} to {unload_temp}C
    M104 T{tool} S{unload_temp}

    # 5) Raise Z a bit for safe unload
    M117 UNLOAD: Z lift
    G91
    G1 Z10 F600
    G90

    # 6) Move to Y=5 so filament cleanup is easy
    M117 UNLOAD: move to Y5
    G90
    G1 Y5 F9000

    # 7) Call real unload routine
    M117 UNLOAD: RUN UNLOAD_FILAMENT
    UNLOAD_FILAMENT

    M117 UNLOAD: done


[gcode_macro LOAD_ONE_FILAMENT]
description: Wrapper for toolchanger UI - load filament into specific tool (probe-based, QGL only if toolchange)
gcode:
    {% set tool = params.TOOL|default(0)|int %}
    {% set state = printer.print_stats.state %}
    {% set load_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set preheat_temp = 125 %}

    M117 LOAD: start T{tool}

    # Block during print or pause
    {% if state in ["printing", "paused"] %}
        M117 LOAD: blocked ({state})
        {action_respond_info("LOAD_ONE_FILAMENT blocked during '%s'." % state)}
        RETURN
    {% endif %}

    # 1) Preheat requested tool to 125C (no wait)
    M117 LOAD: preheat T{tool} to {preheat_temp}C
    M104 T{tool} S{preheat_temp}

    # 2) Detect active tool via tool probe BEFORE any homing
    DETECT_ACTIVE_TOOL_PROBE
    {% if printer.probe.active_tool_number is defined %}
        {% set detected_tool = printer.probe.active_tool_number|int %}
    {% else %}
        {% set detected_tool = -1 %}
    {% endif %}
    {% set is_homed = "xyz" in printer.toolhead.homed_axes %}
    M117 LOAD: detected={detected_tool} homed={is_homed}

    # 3) If we already have the right tool AND we're homed: no G28, no QGL, no toolchange
    {% if detected_tool == tool and is_homed %}
        M117 LOAD: correct tool & homed, no G28/QGL/toolchange

    {% else %}
        # We either have the wrong tool, unknown tool, or not homed.

        {% if not is_homed %}
            M117 LOAD: machine not homed → G28
            G28
            {% set is_homed = True %}
        {% else %}
            M117 LOAD: homed, skipping extra G28
        {% endif %}

        # Re-detect tool after homing, then QGL+toolchange if needed
        DETECT_ACTIVE_TOOL_PROBE
        {% if printer.probe.active_tool_number is defined %}
            {% set detected_tool2 = printer.probe.active_tool_number|int %}
        {% else %}
            {% set detected_tool2 = -1 %}
        {% endif %}
        M117 LOAD: post-home detected={detected_tool2}

        {% if detected_tool2 != tool %}
            # Need a toolchange → ALWAYS QGL first
            M117 LOAD: QGL before toolchange
            QUAD_GANTRY_LEVEL

            M117 LOAD: SELECT_TOOL T{tool}
            SELECT_TOOL T={tool}
        {% else %}
            M117 LOAD: now on correct tool after homing; no toolchange
        {% endif %}
    {% endif %}

    # 4) Heat to load temp (no wait)
    M117 LOAD: heat T{tool} to {load_temp}C
    M104 T{tool} S{load_temp}

    # 5) Raise Z a bit for safe load
    M117 LOAD: Z lift
    G91
    G1 Z10 F600
    G90

    # 6) Move to Y=5 so filament cleanup is easy
    M117 LOAD: move to Y5
    G90
    G1 Y5 F9000

    # 7) Call real load routine
    M117 LOAD: RUN LOAD_FILAMENT
    LOAD_FILAMENT

    M117 LOAD: done
